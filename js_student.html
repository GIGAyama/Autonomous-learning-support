<script>
/**
 * ğŸ§­ ã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ Ver. 1.0 - Student Logic (å…ç«¥ç”¨æ©Ÿèƒ½)
 * ==============================================================================
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å…ç«¥ãƒ¢ãƒ¼ãƒ‰ï¼ˆå­¦ç¿’è€…ç”¨ç”»é¢ï¼‰ã®å‹•ä½œã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
 * ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåå‰é¸æŠï¼‰
 * ãƒ»ä»Šæ—¥ã®å­¦ç¿’ãƒªã‚¹ãƒˆã®è¡¨ç¤º
 * ãƒ»è¨ˆç”»ã®ä½œæˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
 * ãƒ»ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œï¼ˆå®Œäº†ãƒ»é€”ä¸­ãƒ»ãƒ¡ãƒ¢ï¼‰
 * ãƒ»ãµã‚Šã‹ãˆã‚Šã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã€è‡ªåˆ†ç”¨ã‚¿ã‚¤ãƒãƒ¼
 */

// ==========================================
//  1. ãƒ­ã‚°ã‚¤ãƒ³ãƒ»åˆæœŸè¡¨ç¤º (Login & Entry)
// ==========================================

/**
 * [ç”»é¢æç”»] åå‰å…¥åŠ›ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼‰ç”»é¢ã‚’è¡¨ç¤º
 */
function renderNameEntry() {
  let classOptions = '';
  // ã‚¯ãƒ©ã‚¹ãƒªã‚¹ãƒˆãŒã‚ã‚Œã°é¸æŠè‚¢ã‚’ä½œæˆ
  if (dataStore.classList.length > 0) {
     classOptions = dataStore.classList.map(c => `<option value="${c}">${c}</option>`).join('');
  } else {
     classOptions = '<option value="1çµ„">1çµ„</option><option value="2çµ„">2çµ„</option>';
  }

  const container = document.getElementById('app-container');
  container.innerHTML = `
    <div class="row justify-content-center animate__animated animate__fadeIn">
      <div class="col-md-6">
        <div class="card shadow-sm p-5 text-center border-0 rounded-4">
          <h4 class="fw-bold mb-4"><ruby>å§‹<rt>ã¯ã˜</rt></ruby>ã‚ã‚‹</h4>
          
          <!-- ã‚¯ãƒ©ã‚¹é¸æŠ -->
          <div class="mb-3">
             <label class="form-label small text-muted">ã‚¯ãƒ©ã‚¹</label>
             <select id="input-class" class="form-select form-select-lg text-center rounded-pill border-0 bg-light" onchange="updateNameSelect()">
               ${classOptions}
             </select>
          </div>
          
          <!-- åå‰é¸æŠ (ã‚¯ãƒ©ã‚¹ã‚’é¸ã¶ã¨è‡ªå‹•æ›´æ–°) -->
          <div class="mb-4">
             <label class="form-label small text-muted">ãªã¾ãˆ</label>
             <div id="name-input-container">
               <input type="text" id="input-name" class="form-control form-control-lg text-center rounded-pill border-0 bg-light" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">
             </div>
          </div>
          
          <!-- æ¬¡å›çœç•¥ãƒã‚§ãƒƒã‚¯ -->
          <div class="form-check mb-4 d-inline-block">
            <input class="form-check-input" type="checkbox" id="rm-me" checked>
            <label class="form-check-label small" for="rm-me"><ruby>æƒ…å ±<rt>ã˜ã‚‡ã†ã»ã†</rt></ruby>ã‚’<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹</label>
          </div>
          
          <button class="btn btn-primary btn-lg w-100 rounded-pill shadow-sm" onclick="handleLoginClick()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          
          <div class="mt-4">
             <button class="btn btn-link text-muted btn-sm" onclick="attemptTeacherLogin()">å…ˆç”Ÿã¯ã“ã¡ã‚‰</button>
          </div>
        </div>
      </div>
    </div>`;
    
  updateNameSelect(); // åˆæœŸã®åå‰ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
}

/**
 * [å†…éƒ¨å‡¦ç†] ã‚¯ãƒ©ã‚¹é¸æŠã«åˆã‚ã›ã¦åå‰ãƒªã‚¹ãƒˆã‚’æ›´æ–°
 * [æ”¹ä¿®] isActiveãŒfalseï¼ˆè»¢å‡ºãªã©ï¼‰ã®ç”Ÿå¾’ã¯è¡¨ç¤ºã—ãªã„ + å‡ºå¸­ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
 */
function updateNameSelect() {
  const classVal = document.getElementById('input-class').value;
  const container = document.getElementById('name-input-container');
  
  // åœ¨ç±ä¸­(isActive !== false)ã®ã¿æŠ½å‡ºã—ã€å‡ºå¸­ç•ªå·(number)é †ã«ã‚½ãƒ¼ãƒˆ
  const students = dataStore.roster
    .filter(r => r.classId === classVal && r.isActive !== false)
    .sort((a,b) => a.number - b.number);

  if (students.length > 0) {
    const options = students.map(s => `<option value="${s.name}">${s.number}. ${s.name}</option>`).join('');
    container.innerHTML = `
      <select id="input-name" class="form-select form-select-lg text-center rounded-pill border-0 bg-light">
        <option value="" disabled selected>åå‰ã‚’ãˆã‚‰ã‚“ã§ã­</option>
        ${options}
      </select>`;
  } else {
    container.innerHTML = `<input type="text" id="input-name" class="form-control form-control-lg text-center rounded-pill border-0 bg-light" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">`;
  }
}

/**
 * [ã‚¢ã‚¯ã‚·ãƒ§ãƒ³] ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
 */
function handleLoginClick() {
  const nameInput = document.getElementById('input-name');
  const classInput = document.getElementById('input-class');
  const remember = document.getElementById('rm-me').checked;
  
  const name = nameInput.value.trim();
  const cls = classInput.value;
  
  if (!name) return; // åå‰ãŒç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
  
  // ãƒ–ãƒ©ã‚¦ã‚¶ã«æƒ…å ±ã‚’ä¿å­˜ï¼ˆæ¬¡å›çœç•¥ç”¨ï¼‰
  if (remember) {
    localStorage.setItem(CONSTANTS.LS_KEY_NAME, name);
    localStorage.setItem(CONSTANTS.LS_KEY_CLASS, cls);
  } else {
    localStorage.removeItem(CONSTANTS.LS_KEY_NAME);
    localStorage.removeItem(CONSTANTS.LS_KEY_CLASS);
  }
  
  // ã‚¢ãƒ—ãƒªçŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã¸
  appState.user.name = name;
  appState.user.classId = cls;
  loginStudent(false);
}

/**
 * [ã‚µãƒ¼ãƒãƒ¼é€šä¿¡] ç”Ÿå¾’ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã€è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
 * @param {boolean} isAuto - è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‹ã©ã†ã‹ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®åˆ¶å¾¡ç”¨ï¼‰
 */
function loginStudent(isAuto) {
  if (!isAuto) showLoading();
  
  // ã‚µãƒ¼ãƒãƒ¼(Code.gs)ã® getStudentProgress ã‚’å‘¼ã³å‡ºã—
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        const d = JSON.parse(res.json);
        
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸå€‹äººãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
        dataStore.studentProgress = d.progress || {};
        dataStore.studentFeedback = d.feedback || {};
        dataStore.myTasks = d.myTasks || []; // è‡ªåˆ†ã®ã€Œãƒã‚¤ã‚¿ã‚¹ã‚¯ã€
        dataStore.portfolioData = d.portfolio || { summary: '' };
        dataStore.studentReflections = d.reflections?.[appState.unit.id] || {};
        
        // å­¦ç¿’è¨ˆç”»ãƒ‡ãƒ¼ã‚¿
        if (d.plans && d.plans[appState.unit.id]) {
           dataStore.clsPlans[appState.user.name] = { [appState.unit.id]: d.plans[appState.unit.id] };
        }
        
        syncStudentPlan();      // è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        renderStudentView();    // ç”»é¢æç”»
        
        if (!isAuto) hideLoading();
        
        // è¿½åŠ æ©Ÿèƒ½ã®èµ·å‹•
        renderMyTimer();        // ã‚¿ã‚¤ãƒãƒ¼ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆè¡¨ç¤º
        checkScheduleAndNotify(); // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèª
        unlockAudio();          // éŸ³å£°å†ç”Ÿæº–å‚™
      }
    })
    .withFailureHandler(handleError)
    .getStudentProgress(appState.user.name, appState.user.classId, appState.unit.id);
}

// ==========================================
//  2. ç”»é¢æç”»åˆ¶å¾¡ (View Controller)
// ==========================================

/**
 * [æ©Ÿèƒ½] ç”Ÿå¾’ç”»é¢ã®æç”»æŒ¯ã‚Šåˆ†ã‘
 * ã€Œä»Šæ—¥ã®å­¦ç¿’(daily)ã€ã‹ã€Œè¨ˆç”»ä½œæˆ(planning)ã€ã‹ã‚’åˆ¤æ–­ã—ã¦æç”»ã—ã¾ã™ã€‚
 */
function renderStudentView() { 
  if (appState.view.student === 'planning') {
    renderStudentPlanning(); 
  } else {
    renderStudentDaily(); 
  }
}

/**
 * [ç”»é¢æç”»] ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆè¨ˆç”» â‡” ä»Šæ—¥ï¼‰
 */
function setStudentViewMode(mode) { 
  appState.view.student = mode; 
  renderStudentView(); 
}

/**
 * [ç”»é¢æç”»] ç¾åœ¨ã®æ™‚æ•°ã‚’å¤‰æ›´ï¼ˆ1æ™‚é–“ç›®ã€2æ™‚é–“ç›®...ï¼‰
 */
function changeCurrentHour(h) { 
  appState.unit.currentHour = parseInt(h); 
  renderStudentView(); 
}

// ==========================================
//  3. ä»Šæ—¥ã®å­¦ç¿’ç”»é¢ (Daily View)
// ==========================================

function renderStudentDaily() {
  const container = document.getElementById('app-container');
  
  // è‡ªåˆ†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆSOSãªã©ï¼‰å–å¾—
  const myStat = dataStore.liveStatus.find(d => d.name === appState.user.name) || { mode: 'é€šå¸¸' };
  
  // è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯ã®æŠ½å‡º
  const currentTasks = getCurrentUnitTasks();
  const myTasksFiltered = dataStore.myTasks.filter(t => t.unitId === appState.unit.id);
  const allTasks = [...currentTasks, ...myTasksFiltered];
  
  // è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®ä¸¦ã³é †ã‚’æ­£ã¨ã—ã¦ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹
  const hourKey = String(appState.unit.currentHour);
  const plannedIds = dataStore.studentPlan[hourKey] || [];
  
  // è¡¨ç¤ºç”¨ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
  let todaysTasks = [];
  
  // 1. è¨ˆç”»ã«ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ã€Œé †åºé€šã‚Šã€ã«è¿½åŠ 
  plannedIds.forEach(tid => {
    const t = allTasks.find(at => at.taskId === tid);
    if (t) todaysTasks.push(t);
  });

  // 2. è¨ˆç”»ã«å«ã¾ã‚Œã¦ã„ãªã„ã€Œå…ˆç”Ÿå›ºå®šã‚¿ã‚¹ã‚¯ã€ãŒã‚ã‚Œã°å…ˆé ­ã«è¿½åŠ  (æœªè¨ˆç”»æ™‚ã®å¯¾å¿œ)
  const fixedTasks = allTasks.filter(t => t.format === 'teacher' && getStepNumber(t.step) === appState.unit.currentHour);
  fixedTasks.forEach(ft => {
    // ã¾ã ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°å…ˆé ­ã«è¿½åŠ 
    if (!todaysTasks.some(t => t.taskId === ft.taskId)) {
       todaysTasks.unshift(ft);
    }
  });
  
  // åˆè¨ˆæ™‚é–“ã‚’è¨ˆç®—
  let totalTime = 0; 
  todaysTasks.forEach(t => totalTime += t.time);
  
  // é€²æ—ãƒãƒ¼ã®è¨­å®š
  const timePercent = Math.min((totalTime / CONSTANTS.UNIT_TIME) * 100, 100);
  let timeColor = totalTime > CONSTANTS.UNIT_TIME ? 'bg-danger' : (totalTime > CONSTANTS.UNIT_TIME * 0.8 ? 'bg-warning' : 'bg-success');
  
  // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆHTMLç”Ÿæˆ
  let taskListHtml = todaysTasks.length === 0 
    ? `<div class="text-center py-5 text-muted"><p>è¨ˆç”»ãŒå…¥ã£ã¦ã„ã¾ã›ã‚“</p><button class="btn btn-outline-primary rounded-pill" onclick="setStudentViewMode('planning')">è¨ˆç”»ã‚’ç«‹ã¦ã‚‹</button></div>` 
    : todaysTasks.map(t => createStudentTaskCard(t)).join('');
  
  // æ™‚æ•°é¸æŠè‚¢ã®ç”Ÿæˆ
  const effectiveHours = getEffectiveTotalHours();
  let hourOptions = ''; 
  for(let i = 1; i <= effectiveHours; i++) { 
    hourOptions += `<option value="${i}" ${i === appState.unit.currentHour ? 'selected' : ''}>ç¬¬${i}æ™‚</option>`; 
  }
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ï¼ˆSOSãªã©ï¼‰
  let stBadge = ''; let rstBtn = 'd-none';
  if (myStat.mode === 'ãŸã™ã‘ã¦' || myStat.mode === 'sos') { 
    stBadge = `<span class="badge bg-danger rounded-pill px-2 py-1 me-2 animate__animated animate__flash">SOS</span>`; rstBtn = ''; 
  } else if (myStat.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' || myStat.mode === 'focus') { 
    stBadge = `<span class="badge bg-info text-white rounded-pill px-2 py-1 me-2 animate__animated animate__pulse">é›†ä¸­</span>`; rstBtn = ''; 
  }
  
  // å˜å…ƒã®ç›®æ¨™è¡¨ç¤º
  const currentUnit = appState.unitList.find(u => u.id === appState.unit.id) || {};
  const goalHtml = currentUnit.goal 
    ? `<div class="alert alert-success border-0 shadow-sm d-flex align-items-center py-2 px-3 mb-3 small">
         <i class="bi bi-flag-fill text-success me-2 fs-5"></i>
         <div class="fw-bold flex-grow-1">${currentUnit.goal}</div>
       </div>` : '';

  // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®HTMLæ§‹ç¯‰
  container.innerHTML = `
    ${goalHtml}
    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ»é€²æ—ãƒãƒ¼ -->
    <div class="timeline-container shadow-sm p-3 mb-3 rounded-bottom border-bottom">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <select class="form-select form-select-sm w-auto fw-bold text-primary border-0 bg-transparent" onchange="changeCurrentHour(this.value)">${hourOptions}</select>
        <div class="small fw-bold ${totalTime > CONSTANTS.UNIT_TIME ? 'text-danger' : 'text-muted'}">${totalTime} / ${CONSTANTS.UNIT_TIME}åˆ†</div>
      </div>
      <div class="progress" style="height: 1.5rem;">
        <div class="progress-bar progress-bar-striped ${timeColor}" role="progressbar" style="width: ${timePercent}%"></div>
      </div>
    </div>
    
    <div class="px-2">
      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="fw-bold text-primary me-2 text-truncate" style="max-width:150px;">
          <i class="bi bi-person-circle me-1"></i>${appState.user.name} 
          <span class="badge bg-light text-secondary border ms-1">${appState.user.classId}</span>
        </div>
        <div class="d-flex gap-2">
          <!-- [è¿½åŠ ] ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚¦ã‚©ãƒ¼ã‚¯ãƒœã‚¿ãƒ³ -->
          <button class="btn btn-warning btn-sm rounded-pill text-dark" onclick="renderGalleryWalk()" title="ã¿ã‚“ãªã®è¨ˆç”»ã‚’è¦‹ã‚‹">
            <i class="bi bi-grid-3x3-gap-fill"></i> ã¿ã‚“ãª
          </button>
          
          <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="setStudentViewMode('planning')"><i class="bi bi-calendar-range"></i> <ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby></button>
          <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="renderPortfolioModal('${appState.user.name}')"><i class="bi bi-journal-text"></i></button>
          <button class="btn btn-outline-success btn-sm rounded-pill" onclick="openDailyReflectionModal()"><i class="bi bi-pencil-square"></i> ãµã‚Šã‹ãˆã‚Š</button>
        </div>
      </div>
      
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³ (SOS/é›†ä¸­) -->
      <div class="d-flex justify-content-end align-items-center mb-2">
        ${stBadge}
        <div class="d-flex gap-1">
          <button class="btn btn-danger btn-sm rounded-pill px-3" onclick="submitUserStatus('ãŸã™ã‘ã¦')">SOS</button>
          <button class="btn btn-info btn-sm rounded-pill px-3 text-white" onclick="submitUserStatus('ã—ã‚…ã†ã¡ã‚…ã†')">é›†ä¸­</button>
          <button class="btn btn-secondary btn-sm rounded-pill px-3 ${rstBtn}" onclick="submitUserStatus('é€šå¸¸')">è§£é™¤</button>
        </div>
      </div>
      
      <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ -->
      ${taskListHtml}
      
      <div class="d-grid gap-2 mb-4 mt-3">
        <button class="btn btn-outline-primary border-2 border-dashed py-3 rounded-4" onclick="openMyTaskModal()">
          <i class="bi bi-plus-circle-fill me-2"></i>ã˜ã¶ã‚“ã®<ruby>èª²é¡Œ<rt>ã‹ã ã„</rt></ruby>
        </button>
      </div>
    </div>`;
}

/**
 * [HTMLç”Ÿæˆ] ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰1æšåˆ†ã®HTMLã‚’ä½œæˆ
 */
function createStudentTaskCard(t) {
  const prog = dataStore.studentProgress[t.taskId] || {};
  const stamp = dataStore.studentFeedback[t.taskId];
  const isDone = prog.status === 'å®Œäº†'; 
  const isDoing = prog.status === 'é€”ä¸­';
  
  // ãƒ­ãƒƒã‚¯åˆ¤å®šï¼ˆå‰æã‚¿ã‚¹ã‚¯ãŒçµ‚ã‚ã£ã¦ã„ãªã„å ´åˆï¼‰
  let isLocked = false;
  if (t.prerequisites && t.prerequisites.length > 0) {
    const allPreDone = t.prerequisites.every(pid => (dataStore.studentProgress[pid] && dataStore.studentProgress[pid].status === 'å®Œäº†'));
    if (!allPreDone) isLocked = true;
  }
  
  const cardClass = isLocked ? 'card-locked' : '';
  const borderClass = getCategoryColorClass(t.category);
  
  // å…ˆç”Ÿã‹ã‚‰ã®ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤º
  let stampHtml = stamp ? `<div class="stamp-badge animate__animated animate__bounceIn">${{'check':'âœ…','good':'ğŸ‘','great':'ğŸ’®','support':'ğŸš©'}[stamp]||''}</div>` : '';
  
  // Passportãƒœã‚¿ãƒ³
  let passportBtn = '';
  if (t.format !== 'teacher' && t.category !== 'ãƒã‚¤ã‚¿ã‚¹ã‚¯' && appState.passportUrl) {
    passportBtn = `<button class="btn btn-primary rounded-pill px-3 btn-sm fw-bold me-1 shadow-sm" onclick="event.stopPropagation(); launchPassport('${t.taskId}')" title="ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã§å­¦ç¿’ã™ã‚‹"><i class="bi bi-rocket-takeoff-fill"></i></button>`;
  }

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå®Œäº†/é€”ä¸­/Passportï¼‰
  let actionBtn = '';
  if (isDone) { 
    actionBtn = `<button class="btn btn-secondary rounded-pill px-3 btn-sm fw-bold" disabled>å®Œäº†</button>`; 
  } else {
    const doingBtn = isDoing ? 'btn-warning text-dark' : 'btn-outline-warning text-dark';
    let buttons = `<button class="btn btn-outline-success rounded-pill px-3 btn-sm fw-bold" onclick="event.stopPropagation(); submitTaskProgress('${t.taskId}','å®Œäº†',this)">ã§ããŸ</button>`;
    
    if (t.format !== 'teacher') {
       buttons = `<button class="btn ${doingBtn} rounded-pill px-3 btn-sm fw-bold me-1" onclick="event.stopPropagation(); submitTaskProgress('${t.taskId}','é€”ä¸­',this)">é€”ä¸­</button>` + buttons;
       actionBtn = passportBtn + buttons;
    } else {
       actionBtn = buttons;
    }
  }
  if (t.format === 'teacher') actionBtn = `<span class="badge bg-info text-white me-2">å…ˆç”Ÿ</span>` + actionBtn;

  return `
    <div class="card shadow-sm mb-3 card-task ${cardClass} ${borderClass} position-relative" style="cursor:pointer;" onclick="openTaskDetailModal('${t.taskId}')">
      ${stampHtml}
      ${isLocked ? `<div class="position-absolute top-50 start-50 translate-middle text-center" style="z-index:2"><i class="bi bi-lock-fill fs-1 text-secondary"></i><br><span class="badge bg-secondary">ãƒ­ãƒƒã‚¯ä¸­</span></div>` : ''}
      <div class="card-body">
        <div class="d-flex justify-content-end align-items-center mb-2">
           <div class="text-end"><span class="badge bg-light text-secondary border">${t.time}åˆ†</span></div>
        </div>
        <h5 class="fw-bold mb-2">${t.title}</h5>
        <div class="d-flex justify-content-between align-items-center mt-1">
          <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
          <div class="text-end">${actionBtn}</div>
        </div>
      </div>
    </div>`;
}

// ==========================================
//  4.5 ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚¦ã‚©ãƒ¼ã‚¯ (Gallery Walk)
// ==========================================

let isGalleryAnonymous = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åŒ¿å

function renderGalleryWalk() {
  const container = document.getElementById('app-container');
  const unitId = appState.unit.id;
  const currentTasks = getCurrentUnitTasks();
  const allTasks = [...currentTasks, ...dataStore.myTasks]; // ãƒã‚¤ã‚¿ã‚¹ã‚¯ã‚‚å«ã‚ã‚‹
  
  // ã‚¯ãƒ©ã‚¹å…¨å“¡ã®è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  // dataStore.clsPlans = { "ç”Ÿå¾’å": { "unitId": { "1": [ids], "2": [ids]... } } }
  // dataStore.roster ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ã“ã¨ã§ã€è¨ˆç”»æœªä½œæˆã®å­ã‚‚è¡¨ç¤ºã™ã‚‹
  
  // ç¾åœ¨ã®ã‚¯ãƒ©ã‚¹ã®ç”Ÿå¾’ãƒªã‚¹ãƒˆ
  const students = dataStore.roster.filter(r => r.classId === appState.user.classId).sort((a,b) => a.number - b.number);
  
  let cardsHtml = '';
  
  students.forEach((s, idx) => {
    // è‡ªåˆ†ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè‡ªåˆ†ã®ç”»é¢ã§è¦‹ã¦ã„ã‚‹ã®ã§ï¼‰
    if (s.name === appState.user.name) return;

    const displayName = isGalleryAnonymous ? `ãŠã¨ã‚‚ã ã¡ ${s.number}` : s.name;
    const plan = (dataStore.clsPlans[s.name] && dataStore.clsPlans[s.name][unitId]) ? dataStore.clsPlans[s.name][unitId] : null;
    
    let planContentHtml = '';
    
    if (!plan) {
      planContentHtml = `<div class="text-center text-muted small py-4">ã¾ã è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    } else {
      // 1æ™‚é–“ç›®ï½ç·æ™‚æ•°ã¾ã§ã®è¨ˆç”»ã‚’å¯è¦–åŒ–
      const totalHours = appState.unit.totalHours; // å…±é€šæ™‚æ•°ã‚’ä½¿ç”¨
      for (let h = 1; h <= totalHours; h++) {
        const taskIds = plan[String(h)] || [];
        let blocksHtml = '';
        
        taskIds.forEach(tid => {
          const t = allTasks.find(at => at.taskId === tid);
          if (t) {
            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²ã‚¯ãƒ©ã‚¹
            let colorClass = 'bg-other';
            if (t.category.includes('ã¾ãªã¶')) colorClass = 'bg-manabu';
            else if (t.category.includes('ãµã‹ã‚ã‚‹')) colorClass = 'bg-fukameru';
            else if (t.category.includes('ã¾ã¨ã‚ã‚‹')) colorClass = 'bg-matomeru';
            else if (t.category === 'ãƒã‚¤ã‚¿ã‚¹ã‚¯') colorClass = 'bg-mytask';
            
            blocksHtml += `<div class="mini-task-block ${colorClass}" data-title="${t.title}"></div>`;
          }
        });
        
        if (blocksHtml === '') blocksHtml = `<div class="w-100 text-center text-muted" style="font-size:0.6rem; background:#f8f9fa;">-</div>`;

        planContentHtml += `
          <div class="mini-timeline-row">
            <div class="mini-timeline-label">${h}</div>
            <div class="mini-timeline-track">${blocksHtml}</div>
          </div>`;
      }
    }

    cardsHtml += `
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card gallery-card h-100 shadow-sm border-0 rounded-3">
          <div class="card-header bg-white border-bottom-0 pt-3 pb-1">
            <div class="d-flex align-items-center">
              <div class="rounded-circle bg-light text-secondary d-flex align-items-center justify-content-center me-2 fw-bold small" style="width:32px; height:32px;">
                ${s.number}
              </div>
              <div class="fw-bold text-truncate text-secondary small">${displayName}</div>
            </div>
          </div>
          <div class="card-body px-2 py-2">
            ${planContentHtml}
          </div>
        </div>
      </div>
    `;
  });

  const anonBtnText = isGalleryAnonymous ? '<i class="bi bi-eye"></i> åå‰ã‚’ã¿ã‚‹' : '<i class="bi bi-eye-slash"></i> åå‰ã‚’ã‹ãã™';
  const anonBtnClass = isGalleryAnonymous ? 'btn-outline-secondary' : 'btn-secondary';

  container.innerHTML = `
    <div class="d-flex flex-column h-100 p-2">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold m-0 text-primary"><i class="bi bi-grid-3x3-gap-fill me-2"></i>ã¿ã‚“ãªã®è¨ˆç”»</h5>
        <div class="d-flex gap-2">
          <button class="btn ${anonBtnClass} btn-sm rounded-pill" onclick="toggleGalleryNames()">${anonBtnText}</button>
          <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="setStudentViewMode('daily')">æˆ»ã‚‹</button>
        </div>
      </div>
      
      <!-- å‡¡ä¾‹ -->
      <div class="d-flex gap-3 mb-3 small text-muted justify-content-center flex-wrap">
        <div class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-1 bg-manabu" style="width:10px;height:10px;"></span>ã¾ãªã¶</div>
        <div class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-1 bg-fukameru" style="width:10px;height:10px;"></span>ãµã‹ã‚ã‚‹</div>
        <div class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-1 bg-matomeru" style="width:10px;height:10px;"></span>ã¾ã¨ã‚ã‚‹</div>
        <div class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-1 bg-mytask" style="width:10px;height:10px;"></span>ãƒã‚¤ã‚¿ã‚¹ã‚¯</div>
      </div>

      <!-- ã‚®ãƒ£ãƒ©ãƒªãƒ¼ -->
      <div class="overflow-auto flex-grow-1">
        <div class="row g-3 pb-5">
          ${cardsHtml}
        </div>
      </div>
    </div>
  `;
}

function toggleGalleryNames() {
  isGalleryAnonymous = !isGalleryAnonymous;
  renderGalleryWalk();

  const container = document.getElementById('app-container');
  container.innerHTML = `
    <div class="row justify-content-center animate__animated animate__fadeIn">
      <div class="col-md-6">
        <div class="card shadow-sm p-5 text-center border-0 rounded-4">
          <h4 class="fw-bold mb-4"><ruby>å§‹<rt>ã¯ã˜</rt></ruby>ã‚ã‚‹</h4>
          <div class="mb-3">
             <label class="form-label small text-muted">ã‚¯ãƒ©ã‚¹</label>
             <select id="input-class" class="form-select form-select-lg text-center rounded-pill border-0 bg-light" onchange="updateNameSelect()">
               ${classOptions}
             </select>
          </div>
          <div class="mb-4">
             <label class="form-label small text-muted">ãªã¾ãˆ</label>
             <div id="name-input-container">
               <input type="text" id="input-name" class="form-control form-control-lg text-center rounded-pill border-0 bg-light" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">
             </div>
          </div>
          <div class="form-check mb-4 d-inline-block">
            <input class="form-check-input" type="checkbox" id="rm-me" checked>
            <label class="form-check-label small" for="rm-me"><ruby>æƒ…å ±<rt>ã˜ã‚‡ã†ã»ã†</rt></ruby>ã‚’<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹</label>
          </div>
          <button class="btn btn-primary btn-lg w-100 rounded-pill shadow-sm" onclick="handleLoginClick()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <div class="mt-4">
             <button class="btn btn-link text-muted btn-sm" onclick="attemptTeacherLogin()">å…ˆç”Ÿã¯ã“ã¡ã‚‰</button>
          </div>
        </div>
      </div>
    </div>`;
    
  updateNameSelect();
}

/**
 * [å†…éƒ¨å‡¦ç†] ã‚¯ãƒ©ã‚¹é¸æŠã«åˆã‚ã›ã¦åå‰ãƒªã‚¹ãƒˆã‚’æ›´æ–°
 * [æ”¹ä¿®] isActiveãŒfalseï¼ˆè»¢å‡ºãªã©ï¼‰ã®ç”Ÿå¾’ã¯è¡¨ç¤ºã—ãªã„ + å‡ºå¸­ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
 */
function updateNameSelect() {
  const classVal = document.getElementById('input-class').value;
  const container = document.getElementById('name-input-container');
  
  // åœ¨ç±ä¸­(isActive !== false)ã®ã¿æŠ½å‡ºã—ã€å‡ºå¸­ç•ªå·(number)é †ã«ã‚½ãƒ¼ãƒˆ
  const students = dataStore.roster
    .filter(r => r.classId === classVal && r.isActive !== false)
    .sort((a,b) => a.number - b.number);

  if (students.length > 0) {
    const options = students.map(s => `<option value="${s.name}">${s.number}. ${s.name}</option>`).join('');
    container.innerHTML = `
      <select id="input-name" class="form-select form-select-lg text-center rounded-pill border-0 bg-light">
        <option value="" disabled selected>åå‰ã‚’ãˆã‚‰ã‚“ã§ã­</option>
        ${options}
      </select>`;
  } else {
    container.innerHTML = `<input type="text" id="input-name" class="form-control form-control-lg text-center rounded-pill border-0 bg-light" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">`;
  }
}

// ==========================================
//  5. è¨ˆç”»ä½œæˆç”»é¢ (Planning View)
// ==========================================

function renderStudentPlanning() {
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®ä¿å­˜ï¼ˆå†æç”»æ™‚ã«ã‚¬ã‚¿ã¤ã‹ãªã„ã‚ˆã†ã«ï¼‰
  const scrollContainer = document.getElementById('planning-scroll-view');
  const scrollY = scrollContainer ? scrollContainer.scrollTop : 0;
  
  const poolContainer = document.getElementById('task-pool-container'); 
  const poolScrollY = poolContainer ? poolContainer.scrollTop : 0;

  // ã‚¿ã‚¹ã‚¯ã®æ•´ç†
  const currentTasks = getCurrentUnitTasks();
  const myTasksFiltered = dataStore.myTasks.filter(t => t.unitId === appState.unit.id);
  const allTasks = [...currentTasks, ...myTasksFiltered];
  
  // ã€å·¦å´ã€‘ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«ï¼ˆé¸æŠè‚¢ï¼‰
  let taskPoolHtml = `<div class="d-grid gap-2 mb-3 sticky-top bg-white pt-2 pb-2 border-bottom" style="top:0; z-index:5;"><button class="btn btn-outline-primary btn-sm rounded-pill border-dashed" onclick="openMyTaskModal()"><i class="bi bi-plus-lg me-1"></i><ruby>èª²é¡Œ<rt>ã‹ã ã„</rt></ruby>ä½œæˆ</button></div>`;
  
  allTasks.filter(t => t.format !== 'teacher').forEach(t => { 
    const borderClass = getCategoryColorClass(t.category);
    taskPoolHtml += `
      <div class="card p-2 mb-2 shadow-sm task-draggable ${borderClass}" style="${t.category==='ãƒã‚¤ã‚¿ã‚¹ã‚¯'?'background-color:#fbf5ff;':''}" data-id="${t.taskId}" onclick="openTaskDetailModal('${t.taskId}')">
        <div class="small fw-bold">${t.title}</div>
        <div class="d-flex justify-content-between align-items-center mt-1">
          <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
          <span class="x-small text-muted">${t.time}åˆ†</span>
        </div>
      </div>`; 
  });
  
  // ã€å³å´ã€‘æ™‚æ•°ã”ã¨ã®è¨ˆç”»è¡¨
  const effectiveHours = getEffectiveTotalHours();
  let hoursHtml = '';
  
  for(let i = 1; i <= effectiveHours; i++) {
    let plannedTasksHtml = '';
    const plannedIds = dataStore.studentPlan[String(i)] || [];
    let hourTotalTime = 0;
    
    let displayTasks = [];
    
    // è¨ˆç”»æ¸ˆã¿ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
    plannedIds.forEach(tid => {
      const t = allTasks.find(x => x.taskId === tid);
      if (t) displayTasks.push(t);
    });

    // å…ˆç”Ÿã‚¿ã‚¹ã‚¯ï¼ˆå›ºå®šï¼‰ã‚’è‡ªå‹•æŒ¿å…¥
    const fixedTasks = allTasks.filter(t => t.format === 'teacher' && getStepNumber(t.step) === i);
    fixedTasks.forEach(ft => {
      if (!displayTasks.some(t => t.taskId === ft.taskId)) {
         displayTasks.unshift(ft);
      }
    });

    displayTasks.forEach(t => {
      hourTotalTime += t.time;
      const borderClass = getCategoryColorClass(t.category);
      const isTeacher = t.format === 'teacher';
      const badge = isTeacher ? `<span class="badge bg-info text-white me-1" style="font-size:0.6em">å›ºå®š</span>` : '';
      const deleteBtn = isTeacher ? '' : `<i class="bi bi-x text-danger" style="cursor:pointer" onclick="event.stopPropagation(); removeFromPlan('${String(i)}', '${t.taskId}')"></i>`;
      const bgStyle = t.category === 'ãƒã‚¤ã‚¿ã‚¹ã‚¯' ? 'background-color:#fbf5ff;' : (isTeacher ? 'opacity:0.9;' : '');
      
      plannedTasksHtml += `
        <div class="card p-2 mb-2 shadow-sm task-draggable ${borderClass}" style="${bgStyle}" data-id="${t.taskId}" onclick="openTaskDetailModal('${t.taskId}')">
          <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-bold text-truncate">${badge}${t.title}</span>
            ${deleteBtn}
          </div>
          <div class="d-flex justify-content-between align-items-center mt-1">
            <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
            <span class="x-small text-muted">${t.time}åˆ†</span>
          </div>
        </div>`;
    });

    // æ™‚é–“é…åˆ†ã®è¨ˆç®—ï¼ˆè‰²å¤‰åŒ–ï¼‰
    const timeRatio = Math.min(hourTotalTime / CONSTANTS.UNIT_TIME, 1) * 100;
    const barColor = hourTotalTime > CONSTANTS.UNIT_TIME ? '#ffcdd2' : '#c8e6c9'; 
    const headerStyle = `background: linear-gradient(90deg, ${barColor} ${timeRatio}%, #f8f9fa ${timeRatio}%);`;

    hoursHtml += `
      <div class="plan-hour-row mb-3">
        <div class="plan-hour-header-v p-2 fw-bold text-center border rounded-top position-relative" style="${headerStyle}">
          ç¬¬${i}æ™‚ <span class="small ms-2 fw-normal badge bg-white text-dark border">${hourTotalTime}åˆ†</span>
        </div>
        <div class="plan-drop-zone-v p-2 border border-top-0 rounded-bottom" data-hour="${i}" style="min-height: 80px; background-color: #fff;">
          ${plannedTasksHtml}
        </div>
      </div>`;
  }

  const container = document.getElementById('app-container');
  container.innerHTML = `
    <div class="p-3 d-flex flex-column h-100">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
        <div class="d-flex align-items-center">
          <h5 class="fw-bold m-0 me-3"><i class="bi bi-calendar-range me-2 text-primary"></i><ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby>ãƒ¢ãƒ¼ãƒ‰</h5>
          <!-- ç·æ™‚æ•°ã®å¤‰æ›´ãƒœã‚¿ãƒ³ -->
          <div class="input-group input-group-sm w-auto">
            <span class="input-group-text bg-white">å…¨</span>
            <input type="text" class="form-control text-center fw-bold bg-white" value="${effectiveHours}" style="width:40px;" readonly>
            <button class="btn btn-outline-secondary" onclick="changeStudentTotalHours(1)"><i class="bi bi-plus-lg"></i></button>
            <button class="btn btn-outline-secondary" onclick="changeStudentTotalHours(-1)"><i class="bi bi-dash-lg"></i></button>
          </div>
        </div>
        <button class="btn btn-primary rounded-pill px-4 shadow-sm" onclick="setStudentViewMode('daily')"><ruby>å®Œäº†<rt>ã‹ã‚“ã‚Šã‚‡ã†</rt></ruby></button>
      </div>
      <div class="row flex-grow-1" style="min-height:0; height: calc(100vh - 150px);">
        <!-- å·¦å´ï¼šèª²é¡Œãƒ—ãƒ¼ãƒ« -->
        <div class="col-4 h-100 border-end bg-white rounded-start d-flex flex-column">
          <div class="small text-muted mb-2 flex-shrink-0 p-2 border-bottom">èª²é¡Œãƒªã‚¹ãƒˆ</div>
          <div id="task-pool-container" class="flex-grow-1 overflow-auto p-2"><div id="task-pool">${taskPoolHtml}</div></div>
        </div>
        <!-- å³å´ï¼šè¨ˆç”»è¡¨ -->
        <div id="planning-scroll-view" class="col-8 h-100 overflow-auto">
          <div class="plan-container-v h-100 pt-2">
            ${hoursHtml}
          </div>
        </div>
      </div>
    </div>`;

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å¾©å…ƒ
  const newPoolContainer = document.getElementById('task-pool-container'); 
  if (newPoolContainer) newPoolContainer.scrollTop = poolScrollY;

  const newScrollContainer = document.getElementById('planning-scroll-view');
  if (newScrollContainer) newScrollContainer.scrollTop = scrollY;
  
  // Sortable.js (ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—) ã®åˆæœŸåŒ–
  new Sortable(document.getElementById('task-pool'), { group: { name: 'shared', pull: 'clone', put: false }, sort: false, animation: 150 });
  
  document.querySelectorAll('.plan-drop-zone-v').forEach(el => {
    new Sortable(el, {
      group: 'shared',
      sort: true,
      animation: 150,
      draggable: ".task-draggable", 
      onAdd: function (evt) {
        const hour = String(evt.to.getAttribute('data-hour'));
        const newOrder = this.toArray(); 
        updatePlanByOrder(hour, newOrder);
        setTimeout(() => renderStudentPlanning(), 0);
      },
      onUpdate: function (evt) {
        const hour = String(evt.to.getAttribute('data-hour'));
        const newOrder = this.toArray();
        updatePlanByOrder(hour, newOrder);
      },
      onRemove: function (evt) {
        const hour = String(evt.from.getAttribute('data-hour'));
        const newOrder = this.toArray(); 
        updatePlanByOrder(hour, newOrder);
      }
    });
  });
}

// ------------------------------------
//  è¨ˆç”»æ“ä½œãƒ­ã‚¸ãƒƒã‚¯
// ------------------------------------

// è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®ä¸¦ã³é †ã‚’æ›´æ–°ã—ã¦ä¿å­˜
function updatePlanByOrder(hour, newOrderArray) {
  dataStore.studentPlan[hour] = newOrderArray;
  savePlan();
}

// è¨ˆç”»ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
function removeFromPlan(hour, taskId) { 
  if (dataStore.studentPlan[hour]) { 
    dataStore.studentPlan[hour] = dataStore.studentPlan[hour].filter(id => id !== taskId); 
    savePlan(); 
    renderStudentPlanning(); 
  } 
}

// ã‚µãƒ¼ãƒãƒ¼ã¸è¨ˆç”»ã‚’ä¿å­˜
function savePlan() {
  google.script.run
    .withFailureHandler(handleError)
    .saveStudentPlan(appState.user.name, appState.unit.id, dataStore.studentPlan, appState.user.classId);
}

// ç”Ÿå¾’ã®å­¦ç¿’è¨ˆç”»ç”¨ï¼šç·æ™‚æ•°ã®å¤‰æ›´
function getEffectiveTotalHours() {
  if (dataStore.studentPlan._meta && dataStore.studentPlan._meta.totalHours) {
    return parseInt(dataStore.studentPlan._meta.totalHours);
  }
  return appState.unit.totalHours;
}

function changeStudentTotalHours(delta) {
  const current = getEffectiveTotalHours();
  const next = current + delta;
  if (next < 1) return;

  if (!dataStore.studentPlan._meta) dataStore.studentPlan._meta = {};
  dataStore.studentPlan._meta.totalHours = next;
  
  savePlan(); 
  renderStudentPlanning(); 
}

// è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸï¼ˆåˆæœŸåŒ–ï¼‰
function syncStudentPlan() { 
  const plans = dataStore.clsPlans[appState.user.name] || {}; 
  const currentPlan = plans[appState.unit.id] || {}; 
  
  if (!currentPlan._meta) {
    currentPlan._meta = {}; 
  }

  const total = currentPlan._meta.totalHours || appState.unit.totalHours;
  for (let i = 1; i <= total; i++) { 
    if (!currentPlan[String(i)]) currentPlan[String(i)] = []; 
  } 
  dataStore.studentPlan = currentPlan; 
}

// ==========================================
//  6. ã‚¿ã‚¹ã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Progress & Status)
// ==========================================

/**
 * [ã‚¢ã‚¯ã‚·ãƒ§ãƒ³] èª²é¡Œã®é€²æ—ã‚’æ›´æ–°ï¼ˆã§ããŸãƒ»é€”ä¸­ï¼‰
 */
function submitTaskProgress(taskId, status, btnElement) {
  if (status === 'å®Œäº†') {
    btnElement.className = "btn btn-secondary rounded-pill px-4 btn-sm fw-bold animate__animated animate__heartBeat";
    btnElement.innerHTML = `<i class="bi bi-check-circle-fill me-1"></i><ruby>å®Œäº†<rt>ã‹ã‚“ã‚Šã‚‡ã†</rt></ruby>`; 
    btnElement.disabled = true;
  }
  if (!dataStore.studentProgress[taskId]) dataStore.studentProgress[taskId] = {};
  dataStore.studentProgress[taskId].status = status;
  
  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks];
  const t = allTasks.find(x => x.taskId === taskId);
  const mem = dataStore.studentProgress[taskId].reflection || "";
  
  // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡
  google.script.run
    .withFailureHandler(err => console.error(err))
    .updateStatus(appState.user.name, t.taskId, t.title, status, 'é€šå¸¸', mem, appState.user.classId, appState.unit.id);
  
  if (status === 'é€”ä¸­') showToast('info', 'é€”ä¸­çµŒéã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  if (status === 'å®Œäº†') setTimeout(renderStudentView, 1000); // 1ç§’å¾Œã«ç”»é¢æ›´æ–°
}

/**
 * [ã‚¢ã‚¯ã‚·ãƒ§ãƒ³] è‡ªåˆ†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆSOS/é›†ä¸­ï¼‰
 */
function submitUserStatus(mode) {
  const idx = dataStore.liveStatus.findIndex(d => d.name === appState.user.name);
  if (idx >= 0) {
    dataStore.liveStatus[idx].mode = (mode === 'é€šå¸¸' ? '' : mode);
    dataStore.liveStatus[idx].classId = appState.user.classId;
    dataStore.liveStatus[idx].currentUnitId = appState.unit.id;
  }
  renderStudentView();
  
  let msg = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è§£é™¤"; let icon = "success";
  if (mode === 'ãŸã™ã‘ã¦' || mode === 'sos') { msg = "SOSé€ä¿¡ï¼"; icon = "warning"; }
  else if (mode === 'ã—ã‚…ã†ã¡ã‚…ã†' || mode === 'focus') { msg = "é›†ä¸­ãƒ¢ãƒ¼ãƒ‰é–‹å§‹"; icon = "info"; }
  
  if (mode !== 'é€šå¸¸' && mode !== '') showToast(icon, msg);
  
  google.script.run
    .withFailureHandler(err => console.error(err))
    .updateStatus(appState.user.name, 'st_upd', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'æ›´æ–°', mode, '', appState.user.classId, appState.unit.id);
}

// ==========================================
//  7. ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ (Modals)
// ==========================================

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ»ãµã‚Šã‹ãˆã‚Šå…¥åŠ›
 */
function openTaskDetailModal(taskId) {
  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks];
  const t = allTasks.find(x => x.taskId === taskId);
  if (!t) return;

  const mem = (dataStore.studentProgress[taskId] || {}).reflection || "";

  // æ•™æãƒªãƒ³ã‚¯ã®HTMLç”Ÿæˆï¼ˆJSONãƒ‘ãƒ¼ã‚¹å‡¦ç†ã¯ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
  const parseMat = (str) => { try { return JSON.parse(str||'{}'); } catch(e){ return {name:str,url:''}; } };
  const materials = [
    { type: 'textbook', label: 'æ•™ç§‘æ›¸ãƒ»è³‡æ–™', icon: 'bi-book', data: parseMat(t.textbook) },
    { type: 'tablet', label: 'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¢ãƒ—ãƒª', icon: 'bi-tablet', data: parseMat(t.tablet) },
    { type: 'print', label: 'ãƒ—ãƒªãƒ³ãƒˆãƒ»ãã®ä»–', icon: 'bi-file-earmark-text', data: parseMat(t.print) }
  ];

  let materialHtml = '';
  materials.forEach(m => {
    if (m.data && m.data.name) {
      if (m.data.url) {
        materialHtml += `<a href="${m.data.url}" target="_blank" class="btn btn-outline-primary btn-sm w-100 mb-2 text-start text-truncate fw-bold"><i class="bi ${m.icon} me-2"></i>${m.data.name}</a>`;
      } else {
        materialHtml += `<div class="mb-2 text-truncate"><span class="badge bg-light text-dark border me-2"><i class="bi ${m.icon}"></i> ${m.label}</span><span class="small">${m.data.name}</span></div>`;
      }
    }
  });

  // ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆèµ·å‹•ãƒœã‚¿ãƒ³
  let passportLauncherHtml = '';
  if (t.format !== 'teacher' && t.category !== 'ãƒã‚¤ã‚¿ã‚¹ã‚¯' && appState.passportUrl) {
    passportLauncherHtml = `
      <div class="mt-4 pt-3 border-top text-center">
        <button class="btn btn-outline-primary rounded-pill w-100 fw-bold shadow-sm" onclick="launchPassport('${taskId}')">
          <i class="bi bi-rocket-takeoff-fill me-2"></i>ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã§å­¦ç¿’ã™ã‚‹
        </button>
        <div class="x-small text-muted mt-1">â€»åˆ¥ã‚¿ãƒ–ã§ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆãŒé–‹ãã¾ã™</div>
      </div>`;
  }

  Swal.fire({
    title: t.title,
    html: `
      <div class="text-start">
        <p class="small bg-light p-2 rounded mb-3">${t.desc || ""}</p>
        ${materialHtml ? '<div class="mb-3 border p-2 rounded bg-white"><div class="small fw-bold text-primary mb-2"><i class="bi bi-link-45deg"></i> å­¦ç¿’ãƒªãƒ³ã‚¯</div>' + materialHtml + '</div>' : ''}
        <label class="form-label fw-bold small">ãƒ¡ãƒ¢ï¼ˆæ°—ã¥ããƒ»ã‚ã‹ã£ãŸã“ã¨ï¼‰</label>
        <textarea id="ref-txt" class="form-control" rows="3" placeholder="ã“ã“ã«è¨˜éŒ²ã‚’æ®‹ã›ã¾ã™">${mem}</textarea>
        ${passportLauncherHtml}
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'ä¿å­˜',
    confirmButtonColor: '#1a73e8'
  }).then(r => {
    if (r.isConfirmed) {
      const txt = document.getElementById('ref-txt').value;
      if (txt !== mem) {
        if (!dataStore.studentProgress[taskId]) dataStore.studentProgress[taskId] = {};
        dataStore.studentProgress[taskId].reflection = txt;
        const curStatus = dataStore.studentProgress[taskId].status || 'æœªç€æ‰‹';
        google.script.run.updateStatus(appState.user.name, t.taskId, t.title, curStatus, 'é€šå¸¸', txt, appState.user.classId, appState.unit.id);
        showToast('success', 'ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      }
    }
  });
}

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] æ¯æ™‚é–“ã®ãµã‚Šã‹ãˆã‚Šå…¥åŠ›
 */
function openDailyReflectionModal(targetHour = null) {
  const hourToEdit = targetHour || appState.unit.currentHour;
  let ref = { achievement: 'A', comment: '', skills: [] };
  
  if (dataStore.studentReflections && dataStore.studentReflections[hourToEdit]) {
    ref = dataStore.studentReflections[hourToEdit];
  }

  // ã‚¹ã‚­ãƒ«é¸æŠãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
  const skillButtons = SKILL_DEFINITIONS.map(s => {
    const isChecked = ref.skills && ref.skills.includes(s.id);
    return `
      <div class="col-3 col-md-3 mb-2">
        <input type="checkbox" class="btn-check skill-check" id="skill-${s.id}" value="${s.id}" ${isChecked ? 'checked' : ''}>
        <label class="btn btn-outline-${s.color} w-100 rounded-pill btn-sm py-2" for="skill-${s.id}">
          <div class="small fw-light" style="font-size:0.7rem">${s.group}</div>
          <div class="fw-bold">${s.label}</div>
        </label>
      </div>`;
  }).join('');

  Swal.fire({
    title: `<div class="fs-4 fw-bold">ç¬¬${hourToEdit}æ™‚ã®ãµã‚Šã‹ãˆã‚Š</div>`,
    html: `
      <div class="text-start">
        <div class="mb-4">
          <label class="form-label small fw-bold text-muted"><ruby>é”æˆåº¦<rt>ãŸã£ã›ã„ã©</rt></ruby></label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="ach-btn" id="ach-a" value="A" ${ref.achievement==='A'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-a">â— <ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby>é€šã‚Š</label>
            <input type="radio" class="btn-check" name="ach-btn" id="ach-b" value="B" ${ref.achievement==='B'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-b">ã€‡ ã¾ã‚ã¾ã‚</label>
            <input type="radio" class="btn-check" name="ach-btn" id="ach-c" value="C" ${ref.achievement==='C'?'checked':''}>
            <label class="btn btn-outline-primary" for="ach-c">â–³ ã‚ã¾ã‚Š</label>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label small fw-bold text-muted">ä»Šæ—¥<ruby>ç™ºæ®<rt>ã¯ã£ã</rt></ruby>ã—ãŸ<ruby>åŠ›<rt>ã¡ã‹ã‚‰</rt></ruby>ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="row gx-2">
            ${skillButtons}
          </div>
        </div>

        <div>
          <label class="form-label small fw-bold text-muted">ã²ã¨ã“ã¨ã‚³ãƒ¡ãƒ³ãƒˆ</label>
          <textarea id="rf-com" class="form-control bg-light border-0" rows="3" placeholder="ã‚ã‹ã£ãŸã“ã¨ã€æ¬¡ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨">${ref.comment||''}</textarea>
        </div>
      </div>
    `,
    width: '600px',
    showCancelButton: true,
    confirmButtonText: 'è¨˜éŒ²ã™ã‚‹',
    confirmButtonColor: '#1a73e8',
    customClass: { popup: 'rounded-5' },
    preConfirm: () => {
      const achEl = document.querySelector('input[name="ach-btn"]:checked');
      if (!achEl) { Swal.showValidationMessage('é”æˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„'); return false; }
      
      const skills = Array.from(document.querySelectorAll('.skill-check:checked')).map(el => el.value);
      return {
        achievement: achEl.value,
        comment: document.getElementById('rf-com').value,
        skills: skills
      };
    }
  }).then(r => {
    if (r.isConfirmed) {
      const v = r.value;
      if(!dataStore.studentReflections) dataStore.studentReflections = {};
      dataStore.studentReflections[hourToEdit] = v;

      google.script.run.saveDailyReflection(appState.user.name, appState.unit.id, hourToEdit, v.achievement, v.comment, appState.user.classId, v.skills);
      showToast('success', 'ãµã‚Šã‹ãˆã‚Šã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
      renderStudentView(); // æ›´æ–°
    }
  });
}

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªï¼ˆå˜å…ƒã®ã¾ã¨ã‚ãƒ»ã‚°ãƒ©ãƒ•ï¼‰
 */
function renderPortfolioModal(name) {
  const reflections = dataStore.studentReflections || {};
  const summary = dataStore.portfolioData ? dataStore.portfolioData.summary : "";
  const feedback = dataStore.portfolioData ? dataStore.portfolioData.feedback : "";
  const stamp = dataStore.portfolioData ? dataStore.portfolioData.stamp : "";

  // ã‚¹ã‚­ãƒ«é›†è¨ˆ
  const skillCounts = {};
  SKILL_DEFINITIONS.forEach(s => skillCounts[s.id] = 0);
  Object.values(reflections).forEach(r => {
    if (r.skills && Array.isArray(r.skills)) {
      r.skills.forEach(sId => {
        if (skillCounts[sId] !== undefined) skillCounts[sId]++;
      });
    }
  });
  const chartLabels = SKILL_DEFINITIONS.map(s => s.label);
  const chartData = SKILL_DEFINITIONS.map(s => skillCounts[s.id]);
  const maxVal = Math.max(5, ...chartData) + 1;

  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³HTML
  let timelineHtml = '<div class="timeline-wrapper ps-2 border-start border-3 ms-3">';
  const sortedHours = Object.keys(reflections).map(Number).sort((a,b)=>a-b);
  
  if (sortedHours.length === 0) {
    timelineHtml += '<div class="text-muted ms-3 small">ã¾ã ãµã‚Šã‹ãˆã‚Šã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    sortedHours.forEach(h => {
      const r = reflections[h];
      const achIcon = r.achievement === 'A' ? 'â—' : (r.achievement === 'B' ? 'ã€‡' : 'â–³');
      const achColor = r.achievement === 'A' ? 'text-primary' : (r.achievement === 'B' ? 'text-success' : 'text-secondary');
      
      let tagsHtml = '';
      if(r.skills && r.skills.length > 0) {
        tagsHtml = '<div class="mt-1">' + r.skills.map(sid => {
          const def = SKILL_DEFINITIONS.find(d => d.id === sid);
          return def ? `<span class="badge rounded-pill bg-light text-dark border me-1 small fw-normal">${def.label}</span>` : '';
        }).join('') + '</div>';
      }

      timelineHtml += `
        <div class="position-relative mb-4 ms-3">
          <div class="position-absolute top-0 start-0 translate-middle rounded-circle bg-white border border-2" style="width:12px;height:12px;left:-22px!important;"></div>
          <div class="small fw-bold text-muted mb-1 d-flex align-items-center">
            ç¬¬${h}æ™‚ <span class="${achColor} ms-2 fs-6">${achIcon}</span>
            <i class="bi bi-pencil-square text-muted ms-2 cursor-pointer edit-icon" onclick="Swal.close(); setTimeout(() => openDailyReflectionModal(${h}), 300);"></i>
          </div>
          <div class="bg-light p-2 rounded small">${r.comment || 'ã‚³ãƒ¡ãƒ³ãƒˆãªã—'}</div>
          ${tagsHtml}
        </div>`;
    });
  }
  timelineHtml += '</div>';

  // å…ˆç”Ÿã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  let feedbackHtml = '';
  if (feedback || stamp) {
    const stampIcon = {'check':'âœ…','good':'ğŸ‘','great':'ğŸ’®','support':'ğŸš©'}[stamp] || '';
    feedbackHtml = `
      <div class="mt-4 border p-3 rounded bg-white shadow-sm">
        <div class="small fw-bold text-primary mb-2"><i class="bi bi-person-badge-fill me-1"></i>å…ˆç”Ÿã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
        <div class="d-flex align-items-start">
          <div class="display-4 me-3">${stampIcon}</div>
          <div class="flex-grow-1 bg-light p-2 rounded small text-dark">${feedback || 'ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰'}</div>
        </div>
      </div>`;
  }

  Swal.fire({
    title: `<div class="fs-4 fw-bold"><i class="bi bi-journal-text me-2"></i>ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</div>`,
    html: `
      <div class="container-fluid text-start px-0">
        <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
          <li class="nav-item"><button class="nav-link active rounded-pill px-4" id="pills-graph-tab" data-bs-toggle="pill" data-bs-target="#pills-graph" type="button">ã‚°ãƒ©ãƒ•</button></li>
          <li class="nav-item"><button class="nav-link rounded-pill px-4" id="pills-log-tab" data-bs-toggle="pill" data-bs-target="#pills-log" type="button">ã‚ã‚†ã¿</button></li>
          <li class="nav-item"><button class="nav-link rounded-pill px-4" id="pills-sum-tab" data-bs-toggle="pill" data-bs-target="#pills-sum" type="button">ã¾ã¨ã‚</button></li>
        </ul>
        <div class="tab-content" id="pills-tabContent" style="min-height: 300px;">
          <div class="tab-pane fade show active" id="pills-graph" role="tabpanel">
            <div class="chart-container" style="position: relative; height:300px; width:100%">
              <canvas id="skillRadarChart"></canvas>
            </div>
          </div>
          <div class="tab-pane fade" id="pills-log" role="tabpanel">
            <div style="max-height: 350px; overflow-y: auto;">${timelineHtml}</div>
          </div>
          <div class="tab-pane fade" id="pills-sum" role="tabpanel">
             <div class="p-2">
               <div class="small text-muted mb-2">ã“ã®å˜å…ƒã‚’é€šã—ã¦å­¦ã‚“ã ã“ã¨ã€ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚</div>
               <textarea id="pf-summary" class="form-control bg-light border-0" rows="8" placeholder="ã“ã“ã«ã¾ã¨ã‚ã‚’æ›¸ã“ã†...">${summary||''}</textarea>
               <button class="btn btn-primary rounded-pill w-100 mt-3" onclick="saveSummary()"><ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã™ã‚‹</button>
               ${feedbackHtml}
             </div>
          </div>
        </div>
      </div>`,
    width: '650px',
    showCloseButton: true,
    showConfirmButton: false,
    didOpen: () => {
      // ãƒãƒ£ãƒ¼ãƒˆæç”»
      const ctx = document.getElementById('skillRadarChart').getContext('2d');
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'ç™ºæ®ã—ãŸåŠ›',
            data: chartData,
            backgroundColor: 'rgba(26, 115, 232, 0.2)',
            borderColor: 'rgba(26, 115, 232, 1)',
            pointBackgroundColor: 'rgba(26, 115, 232, 1)',
            borderWidth: 2
          }]
        },
        options: {
          scales: {
            r: {
              angleLines: { display: true },
              suggestedMin: 0,
              suggestedMax: maxVal,
              ticks: { stepSize: 1, backdropColor: 'transparent' }
            }
          },
          plugins: { legend: { display: false } },
          maintainAspectRatio: false
        }
      });
    }
  });
}

function saveSummary() {
  const val = document.getElementById('pf-summary').value;
  if(!dataStore.portfolioData) dataStore.portfolioData = {};
  dataStore.portfolioData.summary = val;
  google.script.run.savePortfolio(appState.user.name, appState.unit.id, val, appState.user.classId);
  showToast('success', 'ä¿å­˜ã—ã¾ã—ãŸ');
}

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] ã˜ã¶ã‚“ã®èª²é¡Œä½œæˆ
 */
function openMyTaskModal() { 
  Swal.fire({ 
    title: 'ã˜ã¶ã‚“ã®èª²é¡Œ', 
    html: `<div class="text-start"><label class="form-label small fw-bold">ã‚¿ã‚¤ãƒˆãƒ«</label><input id="mt-title" class="form-control mb-3"><label class="form-label small fw-bold">ã‚ã‚ã¦</label><textarea id="mt-desc" class="form-control mb-3" rows="2"></textarea><label class="form-label small fw-bold">æ™‚é–“</label><input id="mt-time" type="number" class="form-control" value="15"></div>`, 
    showCancelButton: true, 
    confirmButtonText: 'è¿½åŠ ', 
    preConfirm: () => { 
      const t = document.getElementById('mt-title').value; 
      if (!t) Swal.showValidationMessage('ã‚¿ã‚¤ãƒˆãƒ«å¿…é ˆ'); 
      return { title: t, desc: document.getElementById('mt-desc').value, time: document.getElementById('mt-time').value }; 
    } 
  }).then(r => { 
    if (r.isConfirmed) { 
      const v = r.value; 
      google.script.run.withSuccessHandler((res) => { 
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸIDã‚’ä½¿ç”¨
        const newId = (res && res.taskId) ? res.taskId : "MT_TEMP";
        dataStore.myTasks.push({ 
          taskId: newId, 
          title: v.title, 
          desc: v.desc, 
          time: parseInt(v.time), 
          category: 'ãƒã‚¤ã‚¿ã‚¹ã‚¯', 
          type: 'challenge', 
          format: 'student',
          unitId: appState.unit.id
        }); 
        
        if (appState.view.student === 'planning') {
          renderStudentPlanning(); 
        } else {
          // Dailyãƒ“ãƒ¥ãƒ¼ã®å ´åˆã¯ã€ç¾åœ¨ã®æ™‚æ•°ã«è‡ªå‹•ç™»éŒ²ã™ã‚‹
          const currentHour = String(appState.unit.currentHour);
          if (!dataStore.studentPlan[currentHour]) dataStore.studentPlan[currentHour] = [];
          dataStore.studentPlan[currentHour].push(newId);
          savePlan(); // è¨ˆç”»ã‚’ä¿å­˜
          
          loginStudent(true); // ç”»é¢æ›´æ–°
        }
        showToast('success', 'èª²é¡Œã‚’è¿½åŠ ã—ã€è¨ˆç”»ã«ç™»éŒ²ã—ã¾ã—ãŸ'); 
      }).addMyTask(appState.user.name, v.title, v.desc, v.time, appState.unit.id, appState.user.classId); 
    } 
  }); 
}

// ==========================================
//  8. è‡ªåˆ†ç”¨ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ (Timer Widget)
// ==========================================

function renderMyTimer() {
  if (document.getElementById('my-timer-widget')) return;
  
  const timerHtml = `
    <div id="my-timer-widget" class="card shadow rounded-4 bg-white" style="position:fixed; bottom:20px; right:20px; width:180px; z-index:1050; border:1px solid #ddd;">
      <div class="card-header bg-light border-0 py-1 d-flex justify-content-between align-items-center" style="cursor:move;" onmousedown="dragElement(document.getElementById('my-timer-widget'))">
        <small class="fw-bold text-muted"><i class="bi bi-clock me-1"></i>Timer</small>
        <button type="button" class="btn-close btn-close-sm" aria-label="Close" onclick="document.getElementById('my-timer-widget').classList.toggle('d-none')"></button>
      </div>
      <div class="card-body p-2 text-center">
        <div class="display-5 fw-bold mb-2" id="timer-display" style="font-family:monospace;">00:00</div>
        <div class="btn-group btn-group-sm w-100 mb-2">
          <button class="btn btn-outline-secondary" onclick="setTimerMode('up')">UP</button>
          <button class="btn btn-outline-secondary" onclick="setTimerMode('down')">DOWN</button>
        </div>
        <div class="input-group input-group-sm mb-2" id="timer-input-group" style="display:none;">
          <input type="number" id="timer-input-min" class="form-control" placeholder="åˆ†" min="1" max="60">
          <button class="btn btn-primary" onclick="setTimerTime()">è¨­å®š</button>
        </div>
        <div class="d-flex justify-content-between">
          <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="toggleTimer()" id="timer-btn-toggle"><ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby></button>
          <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="resetTimer()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>
    <button id="timer-launcher" class="btn btn-primary rounded-circle shadow" style="position:fixed; bottom:20px; right:20px; width:50px; height:50px; z-index:1040;" onclick="document.getElementById('my-timer-widget').classList.remove('d-none');">
      <i class="bi bi-stopwatch fs-4"></i>
    </button>
  `;
  document.body.insertAdjacentHTML('beforeend', timerHtml);
}

function setTimerMode(mode) {
  myTimer.mode = mode;
  document.getElementById('timer-input-group').style.display = (mode === 'down' && !myTimer.isActive) ? 'flex' : 'none';
  resetTimer();
}

function setTimerTime() {
  const min = parseInt(document.getElementById('timer-input-min').value);
  if (min > 0) {
    myTimer.seconds = min * 60;
    updateTimerDisplay();
    document.getElementById('timer-input-group').style.display = 'none';
  }
}

function toggleTimer() {
  if (myTimer.isActive) {
    clearInterval(myTimer.interval);
    myTimer.isActive = false;
    document.getElementById('timer-btn-toggle').innerHTML = '<ruby>å†é–‹<rt>ã•ã„ã‹ã„</rt></ruby>';
    document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
  } else {
    if (myTimer.mode === 'down' && myTimer.seconds === 0) return;
    myTimer.isActive = true;
    document.getElementById('timer-btn-toggle').innerHTML = '<ruby>åœæ­¢<rt>ã¦ã„ã—</rt></ruby>';
    document.getElementById('timer-btn-toggle').className = 'btn btn-danger btn-sm rounded-pill px-3';
    
    myTimer.interval = setInterval(() => {
      if (myTimer.mode === 'up') {
        myTimer.seconds++;
      } else {
        myTimer.seconds--;
        if (myTimer.seconds <= 0) {
          clearInterval(myTimer.interval);
          myTimer.isActive = false;
          myTimer.seconds = 0;
          document.getElementById('timer-btn-toggle').innerHTML = '<ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby>';
          document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
          showToast('info', 'æ™‚é–“ã§ã™ï¼');
        }
      }
      updateTimerDisplay();
    }, 1000);
  }
}

function resetTimer() {
  clearInterval(myTimer.interval);
  myTimer.isActive = false;
  myTimer.seconds = 0;
  updateTimerDisplay();
  document.getElementById('timer-btn-toggle').innerHTML = '<ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby>';
  document.getElementById('timer-btn-toggle').className = 'btn btn-primary btn-sm rounded-pill px-3';
  if(myTimer.mode === 'down') document.getElementById('timer-input-group').style.display = 'flex';
}

function updateTimerDisplay() {
  const m = Math.floor(myTimer.seconds / 60);
  const s = myTimer.seconds % 60;
  document.getElementById('timer-display').textContent = `${('0'+m).slice(-2)}:${('0'+s).slice(-2)}`;
}

// ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•
function dragElement(elmnt) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  elmnt.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    e = e || window.event;
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
</script>
