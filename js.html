<script>
/**
 * ã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ v12.1 - Client Side Logic (Bug Fix)
 * ä¿®æ­£: DOM IDã®æ›¸ãæ›ãˆã«ã‚ˆã‚‹ç”»é¢é·ç§»ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£
 */

// ==========================================
//  1. Global State & Constants
// ==========================================

// å®šæ•°
const CONSTANTS = {
  LS_KEY_NAME: 'mirai_student_name',
  LS_KEY_THEME: 'mirai_theme',
  UNIT_TIME: 45,
  REFRESH_INTERVAL: 30000 // 30ç§’
};

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
let appState = {
  mode: typeof INITIAL_MODE !== 'undefined' ? INITIAL_MODE : 'student', // 'student' | 'teacher'
  user: {
    isAdmin: false,
    name: ""
  },
  view: {
    student: 'daily', // 'daily' | 'planning'
    teacher: 'cards'  // 'cards' | 'heatmap' | 'analysis'
  },
  sound: {
    enabled: true,
    unlocked: false,
    prevSosCount: 0
  },
  unit: {
    id: "",
    totalHours: 8,
    currentHour: 1
  }
};

// ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ (ã‚µãƒ¼ãƒãƒ¼åŒæœŸ)
let dataStore = {
  masterTasks: [],
  myTasks: [],     // ç”Ÿå¾’å€‹äººç”¨
  clsMyTasks: {},  // å…ˆç”Ÿç”¨ï¼ˆå…¨ç”Ÿå¾’åˆ†ï¼‰
  liveStatus: [],
  clsProgress: {},
  clsFeedback: {},
  clsPlans: {},
  clsReflections: {},
  studentProgress: {}, // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ç”Ÿå¾’ç”¨
  studentFeedback: {}, // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ç”Ÿå¾’ç”¨
  studentPlan: {},     // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ç”Ÿå¾’ç”¨
  portfolioData: {}    // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ç”Ÿå¾’ç”¨
};

// ä¸€æ™‚çš„ãªè¨ˆç®—ç”¨
let computedState = {
  todaysPlanIds: new Set()
};

let autoRefreshTimer = null;
let ssUrl = "";


// ==========================================
//  2. Initialization & Data Fetching
// ==========================================

window.onload = function() {
  // ãƒ†ãƒ¼ãƒå¾©å…ƒ
  const theme = localStorage.getItem(CONSTANTS.LS_KEY_THEME);
  if (theme === 'dark') {
    document.body.setAttribute('data-theme', 'dark');
    const toggle = document.getElementById('darkModeSwitch');
    if (toggle) toggle.checked = true;
  }
  
  // åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
  google.script.run
    .withSuccessHandler(handleInitialResponse)
    .withFailureHandler(handleError)
    .getAppInitialData();
};

function handleInitialResponse(res) {
  if (!res.success) {
    handleError({ message: res.error });
    return;
  }
  
  appState.user.isAdmin = res.isAdmin;
  ssUrl = res.ssUrl;

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ¢ãƒ¼ãƒ‰æŒ‡å®šãŒãªã„å ´åˆã€æ¨©é™ã«åŸºã¥ã„ã¦è‡ªå‹•è¨­å®š
  if (appState.mode === 'auto') {
    appState.mode = appState.user.isAdmin ? 'teacher' : 'student';
  }

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¨­å®š
  const btnSs = document.getElementById('btn-view-ss');
  if (btnSs && ssUrl) btnSs.onclick = () => window.open(ssUrl, '_blank');
  
  // å…ˆç”Ÿä»¥å¤–ã¯éŸ³è¨­å®šã‚’éš ã™
  if (appState.mode !== 'teacher') {
    const area = document.getElementById('sound-setting-area');
    if (area) area.style.display = 'none';
  }

  if (!res.isInitialized) {
    renderSetupOverlay();
  } else {
    if (appState.mode === 'teacher') startAutoRefresh();
    loadMainData();
  }
}

function startInitialization() {
  unlockAudio();
  showLoading();
  google.script.run
    .withSuccessHandler(r => {
      if (r.success) loadMainData();
      else handleError({ message: r.error });
    })
    .initSystem();
}

function loadMainData() {
  if (document.getElementById('app-container').innerHTML === '') showLoading();
  
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        updateDataStore(res.json);
        renderApp();
        hideLoading();
      } else {
        handleError({ message: res.error });
      }
    })
    .getData();
}

function startAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(() => {
    google.script.run
      .withSuccessHandler(res => {
        if (res.success) {
          updateDataStore(res.json);
          if (appState.mode === 'teacher') {
            // ç”»é¢ãŒæç”»æ¸ˆã¿ã®å ´åˆã®ã¿æ›´æ–°
            if (document.getElementById('t-area')) {
              renderTeacherDashboardContent();
              checkSosAndPlaySound();
            }
          }
        }
      })
      .getData();
  }, CONSTANTS.REFRESH_INTERVAL);
}

/**
 * JSONãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚’æ›´æ–°ã™ã‚‹
 */
function updateDataStore(jsonStr) {
  const d = JSON.parse(jsonStr);
  
  dataStore.masterTasks = d.unit || [];
  dataStore.liveStatus = d.live || [];
  dataStore.clsProgress = d.progress || {};
  dataStore.clsFeedback = d.feedback || {};
  dataStore.clsMyTasks = d.myTasks || {};
  dataStore.clsPlans = d.plans || {};
  dataStore.clsReflections = d.dailyReflections || {};

  // å˜å…ƒæƒ…å ±ã®æ›´æ–°
  if (dataStore.masterTasks.length > 0) {
    appState.unit.id = dataStore.masterTasks[0].unitId;
    appState.unit.totalHours = Number(dataStore.masterTasks[0].totalHours) || 8;
  }
}


// ==========================================
//  3. Routing & Render Dispatcher
// ==========================================

function renderApp() {
  try {
    // å¿µã®ãŸã‚IDã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å½±éŸ¿å›é¿ï¼‰
    const container = document.getElementById('app-container') || document.getElementById('teacher-view-root');
    if (container) container.id = 'app-container';

    if (appState.mode === 'teacher') {
      renderTeacherView();
    } else {
      // å…ç«¥ãƒ¢ãƒ¼ãƒ‰
      const savedName = localStorage.getItem(CONSTANTS.LS_KEY_NAME);
      
      // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®š
      if (!appState.user.name && savedName) {
        appState.user.name = savedName;
        loginStudent(true);
      } else if (!appState.user.name) {
        renderNameEntry();
      } else {
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦æç”»
        syncStudentPlan();
        renderStudentView();
      }
    }
  } catch (e) {
    console.error(e);
    handleError({ message: "æç”»ã‚¨ãƒ©ãƒ¼: " + e.message });
  }
}

function switchMode(newMode) {
  appState.mode = newMode;
  renderApp();
}


// ==========================================
//  4. Student Logic (View & Actions)
// ==========================================

function renderNameEntry() {
  document.getElementById('app-container').innerHTML = `
    <div class="row justify-content-center animate__animated animate__fadeIn">
      <div class="col-md-6">
        <div class="card shadow-sm p-5 text-center border-0 rounded-4">
          <h4 class="fw-bold mb-4">åå‰ã‚’æ•™ãˆã¦ã­</h4>
          <input type="text" id="input-name" class="form-control form-control-lg text-center mb-4 rounded-pill border-0" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">
          <div class="form-check mb-4 d-inline-block">
            <input class="form-check-input" type="checkbox" id="rm-me" checked>
            <label class="form-check-label small" for="rm-me">åå‰ã‚’è¦šãˆã‚‹</label>
          </div>
          <button class="btn btn-primary btn-lg w-100 rounded-pill shadow-sm" onclick="handleLoginClick()">ã¯ã˜ã‚ã‚‹ï¼</button>
        </div>
      </div>
    </div>`;
}

function handleLoginClick() {
  const nameInput = document.getElementById('input-name');
  const remember = document.getElementById('rm-me').checked;
  const name = nameInput.value.trim();
  
  if (!name) return;
  
  if (remember) localStorage.setItem(CONSTANTS.LS_KEY_NAME, name);
  else localStorage.removeItem(CONSTANTS.LS_KEY_NAME);
  
  appState.user.name = name;
  loginStudent(false);
}

function loginStudent(isAuto) {
  if (!isAuto) showLoading();
  
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        const d = JSON.parse(res.json);
        // å€‹äººãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒˆã‚¢ã«ã‚»ãƒƒãƒˆ
        dataStore.studentProgress = d.progress || {};
        dataStore.studentFeedback = d.feedback || {};
        dataStore.myTasks = d.myTasks || [];
        dataStore.portfolioData = d.portfolio || {};
        
        // è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠ½å‡ºã™ã‚‹å ´åˆã‚‚ã‚ã‚‹ãŒã€å€‹äººå–å¾—APIã®çµæœã‚’å„ªå…ˆï¼‰
        if (d.plans && d.plans[appState.unit.id]) {
           dataStore.clsPlans[appState.user.name] = { [appState.unit.id]: d.plans[appState.unit.id] };
        }
        
        syncStudentPlan();
        renderStudentView();
        
        if (!isAuto) hideLoading();
      }
    })
    .getStudentProgress(appState.user.name);
}

function logoutStudent() {
  localStorage.removeItem(CONSTANTS.LS_KEY_NAME);
  appState.user.name = "";
  renderNameEntry();
}

/**
 * è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸï¼ˆé…åˆ—åˆæœŸåŒ–ãªã©ï¼‰
 */
function syncStudentPlan() {
  const plans = dataStore.clsPlans[appState.user.name] || {};
  const currentPlan = plans[appState.unit.id] || {};
  
  // æœªå®šç¾©ã®æ™‚é–“ã¯ç©ºé…åˆ—ã§åˆæœŸåŒ–
  for (let i = 1; i <= appState.unit.totalHours; i++) {
    const k = String(i);
    if (!currentPlan[k]) currentPlan[k] = [];
  }
  
  dataStore.studentPlan = currentPlan;
}

/**
 * å…ç«¥ç”»é¢ã®æç”»ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ†å²ï¼‰
 */
function renderStudentView() {
  if (appState.view.student === 'planning') {
    renderStudentPlanning();
  } else {
    renderStudentDaily();
  }
}

/**
 * å…ç«¥ï¼šæœ¬æ™‚ã®å­¦ç¿’ç”»é¢ï¼ˆDaily Viewï¼‰
 */
function renderStudentDaily() {
  const myStat = dataStore.liveStatus.find(d => d.name === appState.user.name) || { mode: 'é€šå¸¸' };
  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks];
  
  // ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯IDé›†åˆã‚’æ§‹ç¯‰
  computedState.todaysPlanIds = new Set();
  const hourKey = String(appState.unit.currentHour);
  const plannedIds = dataStore.studentPlan[hourKey] || [];
  
  plannedIds.forEach(tid => computedState.todaysPlanIds.add(tid));
  
  // å…ˆç”Ÿä¸»å°ã‚¿ã‚¹ã‚¯ã¯å¼·åˆ¶è¿½åŠ 
  allTasks.forEach(t => {
    if (t.format === 'teacher') computedState.todaysPlanIds.add(t.taskId);
  });
  
  // è¡¨ç¤ºã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const todaysTasks = allTasks.filter(t => computedState.todaysPlanIds.has(t.taskId));
  
  // æ™‚é–“è¨ˆç®—
  let totalTime = 0;
  todaysTasks.forEach(t => totalTime += t.time);
  const timePercent = Math.min((totalTime / CONSTANTS.UNIT_TIME) * 100, 100);
  let timeColor = totalTime > CONSTANTS.UNIT_TIME ? 'bg-danger' : (totalTime > CONSTANTS.UNIT_TIME * 0.8 ? 'bg-warning' : 'bg-success');

  // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆHTMLç”Ÿæˆ
  let taskListHtml = '';
  if (todaysTasks.length === 0) {
    taskListHtml = `
      <div class="text-center py-5 text-muted">
        <p>ã“ã®æ™‚é–“ã®è¨ˆç”»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        <button class="btn btn-outline-primary rounded-pill" onclick="setStudentViewMode('planning')">è¨ˆç”»ã‚’ç«‹ã¦ã‚‹</button>
      </div>`;
  } else {
    taskListHtml = todaysTasks.map(t => createStudentTaskCard(t)).join('');
  }

  // æ™‚é–“é¸æŠè‚¢
  let hourOptions = '';
  for(let i = 1; i <= appState.unit.totalHours; i++) {
    hourOptions += `<option value="${i}" ${i === appState.unit.currentHour ? 'selected' : ''}>ç¬¬${i}æ™‚</option>`;
  }

  // æŒ¯ã‚Šè¿”ã‚Šãƒœã‚¿ãƒ³çŠ¶æ…‹
  const refData = (dataStore.clsReflections[appState.user.name] && 
                   dataStore.clsReflections[appState.user.name][appState.unit.id] && 
                   dataStore.clsReflections[appState.user.name][appState.unit.id][appState.unit.currentHour]) || {};
  const refBtnClass = refData.achievement ? 'btn-success' : 'btn-outline-success';

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
  let stBadge = '';
  let rstBtn = 'd-none';
  if (myStat.mode === 'ãŸã™ã‘ã¦') { 
    stBadge = `<span class="badge bg-danger rounded-pill px-2 py-1 me-2 animate__animated animate__flash">SOS</span>`; 
    rstBtn = ''; 
  } else if (myStat.mode === 'ã—ã‚…ã†ã¡ã‚…ã†') { 
    stBadge = `<span class="badge bg-info text-white rounded-pill px-2 py-1 me-2 animate__animated animate__pulse">é›†ä¸­</span>`; 
    rstBtn = ''; 
  }

  document.getElementById('app-container').innerHTML = `
    <div class="timeline-container shadow-sm p-3 mb-3 rounded-bottom border-bottom">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <select class="form-select form-select-sm w-auto fw-bold text-primary border-0 bg-transparent" onchange="changeCurrentHour(this.value)">${hourOptions}</select>
        <div class="small fw-bold ${totalTime > CONSTANTS.UNIT_TIME ? 'text-danger' : 'text-muted'}">${totalTime} / ${CONSTANTS.UNIT_TIME}åˆ†</div>
      </div>
      <div class="progress" style="height: 1.5rem;">
        <div class="progress-bar progress-bar-striped ${timeColor}" role="progressbar" style="width: ${timePercent}%"></div>
      </div>
    </div>
    
    <div class="px-2">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="fw-bold text-primary me-2 text-truncate" style="max-width:150px;"><i class="bi bi-person-circle me-1"></i>${appState.user.name}</div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="setStudentViewMode('planning')"><i class="bi bi-calendar-range"></i> è¨ˆç”»</button>
          <button class="btn ${refBtnClass} btn-sm rounded-pill" onclick="openDailyReflectionModal()"><i class="bi bi-pencil-square"></i> ãµã‚Šã‹ãˆã‚Š</button>
        </div>
      </div>
      
      <div class="d-flex justify-content-end align-items-center mb-2">
        ${stBadge}
        <div class="d-flex gap-1">
          <button class="btn btn-danger btn-sm rounded-pill px-3" onclick="submitUserStatus('ãŸã™ã‘ã¦')">SOS</button>
          <button class="btn btn-info btn-sm rounded-pill px-3 text-white" onclick="submitUserStatus('ã—ã‚…ã†ã¡ã‚…ã†')">é›†ä¸­</button>
          <button class="btn btn-secondary btn-sm rounded-pill px-3 ${rstBtn}" onclick="submitUserStatus('é€šå¸¸')">è§£é™¤</button>
        </div>
      </div>
      
      ${taskListHtml}
      
      <div class="d-grid gap-2 mb-4 mt-3">
        <button class="btn btn-outline-primary border-2 border-dashed py-3 rounded-4" onclick="openMyTaskModal()">
          <i class="bi bi-plus-circle-fill me-2"></i>ã˜ã¶ã‚“ã®èª²é¡Œã‚’ã¤ãã‚‹
        </button>
      </div>
    </div>
    <div class="pb-5"></div>`;
}

function createStudentTaskCard(t) {
  const prog = dataStore.studentProgress[t.taskId] || {};
  const stamp = dataStore.studentFeedback[t.taskId];
  const isDone = prog.status === 'å®Œäº†';
  const isDoing = prog.status === 'é€”ä¸­';
  
  // ãƒ­ãƒƒã‚¯åˆ¤å®š
  let isLocked = false;
  if (t.prerequisites && t.prerequisites.length > 0) {
    const allPreDone = t.prerequisites.every(pid => {
      const pStat = dataStore.studentProgress[pid];
      return pStat && pStat.status === 'å®Œäº†';
    });
    if (!allPreDone) isLocked = true;
  }

  const cardClass = isLocked ? 'card-locked' : '';
  
  // ã‚¹ã‚¿ãƒ³ãƒ—
  let stampHtml = '';
  if (stamp) {
    const icon = {'check':'âœ…','good':'ğŸ‘','great':'ğŸ’®','support':'ğŸš©'}[stamp] || '';
    stampHtml = `<div class="stamp-badge animate__animated animate__bounceIn">${icon}</div>`;
  }

  // ãƒœã‚¿ãƒ³
  let actionBtn = '';
  if (isDone) {
    actionBtn = `<button class="btn btn-secondary rounded-pill px-3 btn-sm fw-bold" disabled>å®Œäº†</button>`;
  } else {
    // è¨ˆç”»ã«å…¥ã£ã¦ã„ã‚‹ã®ã§å®Ÿè¡Œãƒœã‚¿ãƒ³
    const doingBtn = isDoing ? 'btn-warning text-dark' : 'btn-outline-warning text-dark';
    let buttons = `<button class="btn btn-outline-success rounded-pill px-3 btn-sm fw-bold" onclick="event.stopPropagation(); submitTaskProgress('${t.taskId}','å®Œäº†',this)">ã§ããŸ</button>`;
    
    if (t.format !== 'teacher') {
      buttons = `<button class="btn ${doingBtn} rounded-pill px-3 btn-sm fw-bold me-1" onclick="event.stopPropagation(); submitTaskProgress('${t.taskId}','é€”ä¸­',this)">é€”ä¸­</button>` + buttons;
    }
    actionBtn = buttons;
  }

  if (t.format === 'teacher') {
    actionBtn = `<span class="badge bg-info text-white me-2"><i class="bi bi-person-video3"></i> å…ˆç”Ÿ</span>` + actionBtn;
  }
  
  // ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¤ã‚³ãƒ³
  let resHtml = '';
  if (t.textbook) resHtml += `<span class="badge bg-light text-dark border me-1"><i class="bi bi-book-half text-primary"></i> ${t.textbook}</span>`;
  if (t.tablet) resHtml += `<span class="badge bg-light text-dark border me-1"><i class="bi bi-tablet-landscape text-success"></i> ${t.tablet}</span>`;
  if (t.print) resHtml += `<span class="badge bg-light text-dark border me-1"><i class="bi bi-file-earmark-text text-danger"></i> ${t.print}</span>`;

  // ãƒ¡ãƒ¢ã‚ã‚Šã‚¢ã‚¤ã‚³ãƒ³
  const hasMemo = prog.reflection && prog.reflection.length > 0;

  return `
    <div class="card shadow-sm mb-3 card-task ${cardClass} position-relative" style="cursor:pointer;" onclick="openTaskDetailModal('${t.taskId}')">
      ${stampHtml}
      ${isLocked ? `<div class="position-absolute top-50 start-50 translate-middle text-center" style="z-index:2"><i class="bi bi-lock-fill fs-1 text-secondary"></i><br><span class="badge bg-secondary">ã¾ã é¸ã¹ã¾ã›ã‚“</span></div>` : ''}
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
           <div class="d-flex align-items-center">
             <span class="badge bg-light text-dark border me-2">${t.category}</span>
             ${resHtml}
             ${hasMemo ? '<i class="bi bi-pencil-fill text-warning ms-2"></i>' : ''}
           </div>
           <div class="text-end"><span class="badge bg-light text-secondary border">${t.time}åˆ†</span></div>
        </div>
        <h5 class="fw-bold mb-2">${t.title}</h5>
        <div class="text-end mt-2 d-flex justify-content-end align-items-center">${actionBtn}</div>
      </div>
    </div>`;
}

/**
 * å…ç«¥ï¼šå˜å…ƒè¨ˆç”»ç”»é¢ï¼ˆPlanning Viewï¼‰
 */
function renderStudentPlanning() {
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ç¶­æŒç”¨
  const planContainer = document.querySelector('.plan-container');
  const scrollX = planContainer ? planContainer.scrollLeft : 0;
  const poolContainer = document.getElementById('task-pool-container'); 
  const poolScrollY = poolContainer ? poolContainer.scrollTop : 0;

  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks].filter(t => t.format !== 'teacher');
  
  // ã‚¿ã‚¹ã‚¯ãƒ—ãƒ¼ãƒ«ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å…ƒï¼‰
  let taskPoolHtml = `
    <div class="d-grid gap-2 mb-3 sticky-top bg-white pt-2 pb-2 border-bottom" style="top:0; z-index:5;">
      <button class="btn btn-outline-primary btn-sm rounded-pill border-dashed" onclick="openMyTaskModal()">
        <i class="bi bi-plus-lg me-1"></i>èª²é¡Œä½œæˆ
      </button>
    </div>`;
  
  allTasks.forEach(t => {
    const isMyTask = t.category === 'ãƒã‚¤ã‚¿ã‚¹ã‚¯';
    const bgStyle = isMyTask ? 'background-color:#fbf5ff;' : '';
    taskPoolHtml += `<div class="card p-2 mb-2 shadow-sm task-draggable" style="${bgStyle}" data-id="${t.taskId}"><div class="small fw-bold">${t.title}</div><div class="x-small text-muted">${t.time}åˆ†</div></div>`;
  });

  // å„æ™‚é–“ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³
  let hoursHtml = '';
  for(let i = 1; i <= appState.unit.totalHours; i++) {
    const k = String(i);
    let plannedTasksHtml = '';
    const plannedIds = dataStore.studentPlan[k] || [];
    
    plannedIds.forEach(tid => {
      const t = allTasks.find(x => x.taskId === tid);
      if (t) {
         const isMyTask = t.category === 'ãƒã‚¤ã‚¿ã‚¹ã‚¯';
         const bgStyle = isMyTask ? 'background-color:#fbf5ff;' : '';
         plannedTasksHtml += `
           <div class="card p-2 mb-2 shadow-sm task-draggable" style="${bgStyle}" data-id="${t.taskId}">
             <div class="d-flex justify-content-between">
               <span class="small fw-bold text-truncate">${t.title}</span>
               <i class="bi bi-x text-danger" style="cursor:pointer" onclick="removeFromPlan('${k}', '${tid}')"></i>
             </div>
           </div>`;
      }
    });

    hoursHtml += `
      <div class="plan-hour-col">
        <div class="plan-hour-header">ç¬¬${i}æ™‚</div>
        <div class="plan-drop-zone" data-hour="${i}">${plannedTasksHtml}</div>
      </div>`;
  }

  document.getElementById('app-container').innerHTML = `
    <div class="p-3 d-flex flex-column h-100">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
        <h5 class="fw-bold m-0"><i class="bi bi-calendar-range me-2 text-primary"></i>å˜å…ƒè¨ˆç”»ã‚’ç«‹ã¦ã‚‹</h5>
        <button class="btn btn-primary rounded-pill px-4 shadow-sm" onclick="setStudentViewMode('daily')">
          <i class="bi bi-check-lg me-1"></i>å®Œäº†ã—ã¦æˆ»ã‚‹
        </button>
      </div>
      <div class="row flex-grow-1" style="min-height:0; height: calc(100vh - 150px);">
        <div class="col-3 h-100 border-end bg-white rounded-start d-flex flex-column">
          <div class="small text-muted mb-2 flex-shrink-0 p-2 border-bottom">èª²é¡Œãƒªã‚¹ãƒˆ</div>
          <div id="task-pool-container" class="flex-grow-1 overflow-auto p-2">
            <div id="task-pool">${taskPoolHtml}</div>
          </div>
        </div>
        <div class="col-9 h-100 overflow-hidden">
          <div class="plan-container h-100 align-items-start pt-2">${hoursHtml}</div>
        </div>
      </div>
    </div>`;

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒ
  const newPlanContainer = document.querySelector('.plan-container');
  if (newPlanContainer) newPlanContainer.scrollLeft = scrollX;
  const newPoolContainer = document.getElementById('task-pool-container');
  if (newPoolContainer) newPoolContainer.scrollTop = poolScrollY;

  // Sortable.js è¨­å®š
  new Sortable(document.getElementById('task-pool'), {
    group: { name: 'shared', pull: 'clone', put: false },
    sort: false, animation: 150
  });
  
  document.querySelectorAll('.plan-drop-zone').forEach(el => {
    new Sortable(el, {
      group: 'shared', sort: true, animation: 150,
      onAdd: function (evt) {
        const tid = evt.item.getAttribute('data-id');
        const h = String(evt.to.getAttribute('data-hour'));
        addToPlan(h, tid);
        evt.item.remove(); // ã‚¯ãƒ­ãƒ¼ãƒ³å…ƒã®DOMã¯ä¸è¦ãªã®ã§å‰Šé™¤ï¼ˆå†æç”»ã§æ•´ãˆã‚‹ï¼‰
      }
    });
  });
}

// --- å…ç«¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

function setStudentViewMode(mode) {
  appState.view.student = mode;
  renderStudentView();
}

function changeCurrentHour(h) {
  appState.unit.currentHour = parseInt(h);
  renderStudentView();
}

function addToPlan(hour, taskId) {
  const k = String(hour);
  if (!dataStore.studentPlan[k]) dataStore.studentPlan[k] = [];
  dataStore.studentPlan[k].push(taskId);
  savePlan();
  renderStudentPlanning();
}

function removeFromPlan(hour, taskId) {
  const k = String(hour);
  if (dataStore.studentPlan[k]) {
    dataStore.studentPlan[k] = dataStore.studentPlan[k].filter(id => id !== taskId);
    savePlan();
    renderStudentPlanning();
  }
}

function savePlan() {
  google.script.run
    .withFailureHandler(handleError)
    .saveStudentPlan(appState.user.name, appState.unit.id, dataStore.studentPlan);
}

function togglePlan(taskId) {
  // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: ç¾åœ¨ã®æ™‚é–“ã®è¨ˆç”»ã«è¿½åŠ /å‰Šé™¤
  const k = String(appState.unit.currentHour);
  if (!dataStore.studentPlan[k]) dataStore.studentPlan[k] = [];
  
  if (computedState.todaysPlanIds.has(taskId)) {
    dataStore.studentPlan[k] = dataStore.studentPlan[k].filter(id => id !== taskId);
  } else {
    dataStore.studentPlan[k].push(taskId);
  }
  savePlan();
  renderStudentView();
}

function submitTaskProgress(taskId, status, btnElement) {
  // æ¥½è¦³çš„æ›´æ–°
  if (status === 'å®Œäº†') {
    btnElement.className = "btn btn-secondary rounded-pill px-4 btn-sm fw-bold animate__animated animate__heartBeat";
    btnElement.innerHTML = `<i class="bi bi-check-circle-fill me-1"></i>å®Œäº†`; 
    btnElement.disabled = true;
  }
  
  if (!dataStore.studentProgress[taskId]) dataStore.studentProgress[taskId] = {};
  dataStore.studentProgress[taskId].status = status;
  
  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks];
  const t = allTasks.find(x => x.taskId === taskId);
  const mem = dataStore.studentProgress[taskId].reflection || "";
  
  google.script.run
    .withFailureHandler(err => console.error(err))
    .updateStatus(appState.user.name, t.taskId, t.title, status, 'é€šå¸¸', mem);
  
  if (status === 'é€”ä¸­') showToast('info', 'é€”ä¸­çµŒéã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  if (status === 'å®Œäº†') setTimeout(renderStudentView, 1000); // ãƒ­ãƒƒã‚¯è§£é™¤åæ˜ 
}

function submitUserStatus(mode) {
  // æ¥½è¦³çš„æ›´æ–°
  const idx = dataStore.liveStatus.findIndex(d => d.name === appState.user.name);
  if (idx >= 0) dataStore.liveStatus[idx].mode = (mode === 'é€šå¸¸' ? '' : mode);
  else dataStore.liveStatus.push({ name: appState.user.name, mode: mode });
  
  renderStudentView();
  
  let msg = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è§£é™¤ã—ã¾ã—ãŸ";
  let icon = "success";
  if (mode === 'ãŸã™ã‘ã¦') { msg = "SOSã‚’é€ä¿¡ã—ã¾ã—ãŸï¼"; icon = "warning"; }
  else if (mode === 'ã—ã‚…ã†ã¡ã‚…ã†') { msg = "é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ï¼"; icon = "info"; }
  
  showToast(icon, msg);
  
  google.script.run
    .withFailureHandler(err => console.error(err))
    .updateStatus(appState.user.name, 'st_upd', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'æ›´æ–°', mode, '');
}


// --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ (å…ç«¥) ---

function openTaskDetailModal(taskId) {
  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks];
  const t = allTasks.find(x => x.taskId === taskId);
  if (!t || t.isLocked) return;
  
  const mem = (dataStore.studentProgress[taskId] || {}).reflection || "";
  
  Swal.fire({
    title: t.title,
    html: `
      <div class="text-start">
        <p class="small bg-light p-2 rounded">${t.desc || ""}</p>
        <label class="form-label fw-bold small">ãµã‚Šã‹ãˆã‚Šãƒ¡ãƒ¢</label>
        <textarea id="ref-txt" class="form-control" rows="3">${mem}</textarea>
      </div>`,
    showCancelButton: true, confirmButtonText: 'ä¿å­˜'
  }).then(r => {
    if (r.isConfirmed) {
      const txt = document.getElementById('ref-txt').value;
      if (txt !== mem) {
        if (!dataStore.studentProgress[taskId]) dataStore.studentProgress[taskId] = {};
        dataStore.studentProgress[taskId].reflection = txt;
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¶­æŒã—ã¦ä¿å­˜
        const curStatus = dataStore.studentProgress[taskId].status || 'æœªç€æ‰‹';
        
        google.script.run.updateStatus(appState.user.name, t.taskId, t.title, curStatus, 'é€šå¸¸', txt);
        showToast('success', 'ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        renderStudentView();
      }
    }
  });
}

function openDailyReflectionModal() {
  let ref = { achievement: 'A', comment: '' };
  if (dataStore.clsReflections && 
      dataStore.clsReflections[appState.user.name] && 
      dataStore.clsReflections[appState.user.name][appState.unit.id] && 
      dataStore.clsReflections[appState.user.name][appState.unit.id][appState.unit.currentHour]) {
        ref = dataStore.clsReflections[appState.user.name][appState.unit.id][appState.unit.currentHour];
  }

  Swal.fire({
    title: `ç¬¬${appState.unit.currentHour}æ™‚ã®ãµã‚Šã‹ãˆã‚Š`,
    html: `
      <div class="text-start">
        <label class="form-label small fw-bold">é”æˆåº¦</label>
        <select id="rf-ach" class="form-select mb-3">
          <option value="A" ${ref.achievement==='A'?'selected':''}>â— è¨ˆç”»é€šã‚Šã§ããŸ</option>
          <option value="B" ${ref.achievement==='B'?'selected':''}>ã€‡ ã¾ã‚ã¾ã‚ã§ããŸ</option>
          <option value="C" ${ref.achievement==='C'?'selected':''}>â–³ ã‚ã¾ã‚Šã§ããªã‹ã£ãŸ</option>
        </select>
        <label class="form-label small fw-bold">ã²ã¨ã“ã¨ãƒ»æ¬¡å›ã«å‘ã‘ã¦</label>
        <textarea id="rf-com" class="form-control" rows="3">${ref.comment||''}</textarea>
      </div>`,
    showCancelButton: true, confirmButtonText: 'æå‡º'
  }).then(r => {
    if (r.isConfirmed) {
      const a = document.getElementById('rf-ach').value;
      const c = document.getElementById('rf-com').value;
      
      // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
      if(!dataStore.clsReflections[appState.user.name]) dataStore.clsReflections[appState.user.name] = {};
      if(!dataStore.clsReflections[appState.user.name][appState.unit.id]) dataStore.clsReflections[appState.user.name][appState.unit.id] = {};
      dataStore.clsReflections[appState.user.name][appState.unit.id][appState.unit.currentHour] = {achievement:a, comment:c};

      google.script.run.saveDailyReflection(appState.user.name, appState.unit.id, appState.unit.currentHour, a, c);
      showToast('success', 'æå‡ºã—ã¾ã—ãŸ');
      renderStudentView();
    }
  });
}

function openMyTaskModal() {
  Swal.fire({
    title: 'ã˜ã¶ã‚“ã®èª²é¡Œã‚’ã¤ãã‚‹',
    html: `
      <div class="text-start">
        <label class="form-label small fw-bold">ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input id="mt-title" class="form-control mb-3" placeholder="ä¾‹ï¼šå›³æ›¸å®¤ã§æœ¬ã‚’èª¿ã¹ã‚‹">
        <label class="form-label small fw-bold">ã‚„ã‚‹ã“ã¨ãƒ»ã‚ã‚ã¦</label>
        <textarea id="mt-desc" class="form-control mb-3" rows="2"></textarea>
        <label class="form-label small fw-bold">ã‹ã‹ã‚‹æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
        <input id="mt-time" type="number" class="form-control" value="15">
      </div>`,
    showCancelButton: true, confirmButtonText: 'è¿½åŠ ã™ã‚‹', cancelButtonText: 'ã‚„ã‚ã‚‹',
    preConfirm: () => {
      const t = document.getElementById('mt-title').value;
      if (!t) Swal.showValidationMessage('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥ã‚Œã¦ã­');
      return { title: t, desc: document.getElementById('mt-desc').value, time: document.getElementById('mt-time').value };
    }
  }).then(r => {
    if (r.isConfirmed) {
      const v = r.value;
      google.script.run.withSuccessHandler(() => {
        const newId = "MT_TEMP_" + Date.now();
        dataStore.myTasks.push({ taskId: newId, title: v.title, desc: v.desc, time: parseInt(v.time), category: 'ãƒã‚¤ã‚¿ã‚¹ã‚¯', type: 'challenge', format: 'student' });
        
        if (appState.view.student === 'planning') {
          renderStudentPlanning();
        } else {
          loginStudent(true); // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åŒæœŸ
        }
        showToast('success', 'èª²é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      }).addMyTask(appState.user.name, v.title, v.desc, v.time, appState.unit.id);
    }
  });
}

function openPortfolio() {
  const allTasks = [...dataStore.masterTasks, ...dataStore.myTasks];
  const doneTasks = allTasks.filter(t => { 
    const p = dataStore.studentProgress[t.taskId]; 
    return p && p.status === 'å®Œäº†'; 
  });

  let historyHtml = '<div class="portfolio-timeline mt-3">';
  if (doneTasks.length === 0) historyHtml += '<p class="text-muted small">ã¾ã å®Œäº†ã—ãŸèª²é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
  
  doneTasks.forEach(t => {
    const p = dataStore.studentProgress[t.taskId];
    const s = dataStore.studentFeedback[t.taskId];
    let stampHtml = '';
    if (s) stampHtml = `<span class="fs-4 ms-2">${{'check':'âœ…','good':'ğŸ‘','great':'ğŸ’®','support':'ğŸš©'}[s]}</span>`;
    
    historyHtml += `
      <div class="portfolio-item">
        <div class="card shadow-sm border-0 bg-light">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between">
              <h6 class="fw-bold mb-1">${t.title} ${stampHtml}</h6>
              <span class="badge bg-secondary align-self-start">${t.category}</span>
            </div>
            ${p.reflection ? `<div class="small text-muted mt-2 border-top pt-2"><i class="bi bi-chat-quote-fill me-1"></i>${p.reflection}</div>` : ''}
          </div>
        </div>
      </div>`;
  });
  historyHtml += '</div>';

  Swal.fire({
    title: 'ãµã‚Šã‹ãˆã‚Šãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª',
    html: `
      <div class="text-start" style="max-height: 60vh; overflow-y: auto;">
        <div class="alert alert-info border-0 d-flex align-items-center">
          <i class="bi bi-trophy-fill fs-3 me-3 text-warning"></i>
          <div>
            <div class="fw-bold">å®Œäº†ã‚¿ã‚¹ã‚¯: ${doneTasks.length} / ${allTasks.length}</div>
            <div class="small">ç²å¾—ã‚¹ã‚¿ãƒ³ãƒ—: ${Object.keys(dataStore.studentFeedback).length}å€‹</div>
          </div>
        </div>
        <h6 class="fw-bold text-muted border-bottom pb-2">å­¦ç¿’ã®ã‚ã—ã‚ã¨</h6>
        ${historyHtml}
        <hr>
        <label class="form-label fw-bold">å­¦ç¿’å…¨ä½“ã®ãµã‚Šã‹ãˆã‚Š</label>
        <textarea id="pf-summary" class="form-control" rows="4" placeholder="ã“ã®å˜å…ƒã‚’é€šã—ã¦ã€ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã‚„ã€ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ã“ã¨ã¯ï¼Ÿ">${dataStore.portfolioData.summary||""}</textarea>
      </div>`,
    width: '600px',
    showCancelButton: true, confirmButtonText: 'ä¿å­˜ã—ã¦é–‰ã˜ã‚‹', cancelButtonText: 'é–‰ã˜ã‚‹',
    customClass: { confirmButton: 'rounded-pill', cancelButton: 'rounded-pill' }
  }).then(r => {
    if (r.isConfirmed) {
      const summary = document.getElementById('pf-summary').value;
      if (summary !== (dataStore.portfolioData.summary||"")) {
        dataStore.portfolioData.summary = summary;
        google.script.run.savePortfolio(appState.user.name, summary);
        showToast('success', 'ä¿å­˜ã—ã¾ã—ãŸ');
      }
    }
  });
}


// ==========================================
//  5. Teacher Logic (View & Actions)
// ==========================================

function renderTeacherView() {
  const container = document.getElementById('app-container');
  // å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã®åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  container.innerHTML = `
    <div class="card shadow-sm p-4 border-0 rounded-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold m-0 text-primary">
          <i class="bi bi-speedometer2 me-2"></i>ãƒ¢ãƒ‹ã‚¿ãƒ¼ 
          <span class="badge bg-success ms-2 small" style="font-size:0.6rem">AUTO</span>
        </h5>
        <div class="d-flex gap-3 align-items-center">
          <div class="btn-group shadow-sm rounded-pill" role="group">
            <button type="button" class="btn btn-sm ${appState.view.teacher === 'cards' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('cards')">LIVE</button>
            <button type="button" class="btn btn-sm ${appState.view.teacher === 'heatmap' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('heatmap')">ä¸€è¦§</button>
            <button type="button" class="btn btn-sm ${appState.view.teacher === 'analysis' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('analysis')">åˆ†æ</button>
          </div>
          <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="openImportModal()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>
      <div id="t-area"></div>
    </div>`;
  renderTeacherDashboardContent();
}

function setTeacherView(mode) {
  appState.view.teacher = mode;
  // æ ã”ã¨å†æç”»
  renderTeacherView();
}

function renderTeacherDashboardContent() {
  const el = document.getElementById('t-area');
  if (!el) return;
  
  // Analysis View
  if (appState.view.teacher === 'analysis') {
    renderAnalysisView(el);
    return;
  }
  
  // Cards View
  if (appState.view.teacher === 'cards') {
    renderLiveCards(el);
    return;
  }
  
  // Heatmap View
  renderHeatmap(el);
}

function renderLiveCards(container) {
  if (dataStore.liveStatus.length === 0) {
    container.innerHTML = `<div class="text-muted p-5 text-center">å¾…æ©Ÿä¸­...</div>`;
  } else {
    container.innerHTML = `<div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-3">${dataStore.liveStatus.map(s => `
      <div class="col"><div class="card h-100 text-center p-3 shadow-sm border-0 rounded-4 ${s.mode==='ãŸã™ã‘ã¦'?'sos-alert':''}"><div class="fw-bold text-truncate mb-2">${s.name}</div><i class="bi bi-person-circle fs-1 my-2 ${s.mode==='ãŸã™ã‘ã¦'?'text-danger':s.mode==='ã—ã‚…ã†ã¡ã‚…ã†'?'text-info':'text-secondary'}"></i><div class="small text-muted text-truncate">${s.task||'-'}</div><div class="badge bg-light text-muted mt-1 fw-normal">${s.mode}</div></div></div>`).join('')}</div>`;
  }
}

function renderHeatmap(container) {
  if (dataStore.masterTasks.length === 0) { container.innerHTML = `<div class="text-center p-5">èª²é¡Œãƒ‡ãƒ¼ã‚¿ãªã—</div>`; return; }
  
  const students = Array.from(new Set([...dataStore.liveStatus.map(d => d.name), ...Object.keys(dataStore.clsProgress)])).sort();
  if (students.length === 0) { container.innerHTML = `<div class="text-center p-5">ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ãªã—</div>`; return; }

  let h = `<div class="table-responsive mb-4"><table class="table table-borderless heatmap-table"><thead><tr><th style="min-width:100px;text-align:left">åå‰</th>${dataStore.masterTasks.map((t, i) => `<th title="${t.title}" onclick="showTeacherTaskDetailSimple('${t.taskId}')">${t.step ? t.step.replace(/[^0-9]/g, '') : i + 1}</th>`).join('')}</tr></thead><tbody>`;
  
  students.forEach(n => {
    const st = dataStore.liveStatus.find(d => d.name === n);
    const ic = (st && st.mode === 'ãŸã™ã‘ã¦') ? '<i class="bi bi-exclamation-circle-fill text-danger ms-1 animate__animated animate__flash"></i>' : (st && st.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' ? '<i class="bi bi-lightning-fill text-info ms-1"></i>' : '');
    h += `<tr><td class="text-start fw-bold text-truncate" style="max-width:120px;cursor:pointer;text-decoration:underline" onclick="showStudentAllData('${n}')">${n}${ic}</td>`;
    
    const doneList = dataStore.clsProgress[n] || {};
    const feedbackList = dataStore.clsFeedback[n] || {};

    dataStore.masterTasks.forEach(t => {
      const p = doneList[t.taskId] || {};
      const stamp = feedbackList[t.taskId];
      let cls = "";
      let icon = "";
      
      if (p.status === 'å®Œäº†') cls = "heatmap-done";
      else if (p.status === 'é€”ä¸­') cls = "heatmap-doing";
      else if (st && st.mode === 'ãŸã™ã‘ã¦') cls = "heatmap-sos";
      
      if (stamp) {
        if(stamp==='check') icon='âœ…'; if(stamp==='good') icon='ğŸ‘'; if(stamp==='great') icon='ğŸ’®'; if(stamp==='support') icon='ğŸš©';
      }

      h += `<td><div class="heatmap-cell-wrapper" onclick="showStudentTaskDetail('${n}', '${t.taskId}')"><div class="heatmap-cell ${cls}" title="${t.title}">${icon}</div></div></td>`;
    });
    h += '</tr>';
  });
  
  const indexHtml = `<div class="card bg-light border-0 rounded-4 p-3 mt-3"><h6 class="fw-bold text-muted mb-2"><i class="bi bi-list-ol me-2"></i>èª²é¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</h6><div class="row row-cols-1 row-cols-md-2 g-2 small">${dataStore.masterTasks.map((t, i) => `<div class="col" style="cursor:pointer" onclick="showTeacherTaskDetailSimple('${t.taskId}')"><span class="badge bg-secondary me-2" style="width:25px;">${t.step ? t.step.replace(/[^0-9]/g, '') : i + 1}</span><span class="badge bg-white text-dark border me-1">${t.category}</span><span class="text-truncate d-inline-block" style="max-width:200px;vertical-align:middle">${t.title}</span></div>`).join('')}</div></div>`;
  container.innerHTML = h + '</tbody></table></div>' + indexHtml;
}

function renderAnalysisView(container) {
  // åˆ†æãƒ‡ãƒ¼ã‚¿ã¯åˆ¥é€”å–å¾—
  google.script.run.withSuccessHandler(res => {
    const d = JSON.parse(res.json);
    const labels = d.tasks.map(t => t.title.substring(0, 10) + "...");
    const counts = d.tasks.map(t => d.counts[t.id] || 0);
    
    container.innerHTML = `
      <div class="row">
        <div class="col-md-8">
          <h6 class="fw-bold text-muted">å®Œäº†æ•°</h6>
          <div class="chart-container"><canvas id="completionChart"></canvas></div>
        </div>
        <div class="col-md-4">
          <div class="card bg-light border-0 p-3 h-100">
            <h6 class="fw-bold text-muted">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h6>
            <p class="small text-muted">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
            <button class="btn btn-outline-dark w-100 mb-3" onclick="downloadCsv()">
              <i class="bi bi-download me-2"></i>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
          </div>
        </div>
      </div>`;
      
    new Chart(document.getElementById('completionChart'), {
      type: 'bar',
      data: { labels: labels, datasets: [{ label: 'äººæ•°', data: counts, backgroundColor: '#4285f4' }] },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
  }).getAnalysisData();
}

// å…ˆç”Ÿç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«é¡
function showStudentAllData(name) {
  const done = dataStore.clsProgress[name] || {}; 
  const fb = dataStore.clsFeedback[name] || {}; 
  const my = dataStore.clsMyTasks[name] || [];
  const all = [...dataStore.masterTasks, ...my];
  
  let h = '<div class="list-group list-group-flush">';
  all.forEach(t => {
    const p = done[t.taskId] || {}; 
    const s = fb[t.taskId];
    const stamp = s ? {'check':'âœ…','good':'ğŸ‘','great':'ğŸ’®','support':'ğŸš©'}[s] : '';
    const reflectionHtml = p.reflection ? `<div class="small text-muted mt-1 p-2 bg-light border rounded"><i class="bi bi-chat-quote-fill me-1"></i>${p.reflection}</div>` : '';
    const badgeClass = p.status === 'å®Œäº†' ? 'bg-success' : (p.status === 'é€”ä¸­' ? 'bg-warning text-dark' : 'bg-secondary');
    
    h += `<div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div><span class="fw-bold">${t.title}</span> <span class="ms-2">${stamp}</span></div>
              <span class="badge ${badgeClass}">${p.status||'æœª'}</span>
            </div>
            ${reflectionHtml}
          </div>`;
  });
  Swal.fire({ title: `${name} ã•ã‚“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª`, html: `<div class="text-start" style="max-height:60vh;overflow-y:auto;">${h}</div>`, width:'600px', showCloseButton:true, showConfirmButton:false });
}

function showStudentTaskDetail(name, tid) {
  const t = dataStore.masterTasks.find(x => x.taskId === tid);
  const p = (dataStore.clsProgress[name] && dataStore.clsProgress[name][tid]) || {};
  
  Swal.fire({
    title: `${name} ã•ã‚“ã®çŠ¶æ³`,
    html: `
      <div class="text-start">
        <h6 class="fw-bold text-primary">${t.title}</h6>
        <div class="mb-3"><span class="badge bg-secondary me-1">çŠ¶æ…‹: ${p.status||'æœª'}</span></div>
        <div class="p-3 bg-light rounded mb-3 small">${p.reflection||'ãƒ¡ãƒ¢ãªã—'}</div>
        <hr><p class="small text-muted text-center mb-2">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é€ã‚‹</p>
        <div class="d-flex justify-content-center gap-2">
          <button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','check')">âœ…</button>
          <button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','good')">ğŸ‘</button>
          <button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','great')">ğŸ’®</button>
          <button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','support')">ğŸš©</button>
        </div>
      </div>`,
    showConfirmButton: false, showCloseButton: true
  });
}

function showTeacherTaskDetailSimple(tid) {
  const t = dataStore.masterTasks.find(x => x.taskId === tid); if (!t) return;
  Swal.fire({ title: t.title, html: `<div class="text-start"><p class="text-muted border p-3 rounded bg-light mb-0">${t.desc || 'èª¬æ˜ãªã—'}</p><div class="mt-2 text-end small text-muted">æ™‚é–“: ${t.time}åˆ†</div></div>`, showConfirmButton: false, showCloseButton: true });
}

function sendStamp(name, tid, stamp) {
  // æ¥½è¦³çš„æ›´æ–°
  if (!dataStore.clsFeedback[name]) dataStore.clsFeedback[name] = {};
  dataStore.clsFeedback[name][tid] = stamp;
  renderTeacherDashboardContent();
  
  showToast('success', 'ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é€ã‚Šã¾ã—ãŸ');
  google.script.run.sendFeedback(name, tid, stamp);
}

function downloadCsv() {
  const content = [
    ["Student","TaskID","Status","Reflection","Timestamp"], 
    ...Object.keys(dataStore.clsProgress).flatMap(n => 
      Object.keys(dataStore.clsProgress[n]).map(tid => {
        const p = dataStore.clsProgress[n][tid]; 
        return [n,tid,p.status,p.reflection,new Date().toLocaleString()];
      })
    )
  ].map(e => e.join(",")).join("\n");
  
  const blob = new Blob([content], {type:'text/csv'}); 
  const url = URL.createObjectURL(blob); 
  const a = document.createElement("a"); 
  a.href = url; a.download = "learning_logs.csv"; 
  a.click();
}

function openImportModal() {
  Swal.fire({ 
    title: 'JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 
    html: '<textarea id="ji" class="form-control" rows="10"></textarea>', 
    showCancelButton: true, confirmButtonText: 'å®Ÿè¡Œ' 
  }).then(r => {
    if (r.isConfirmed) { 
      showLoading(); 
      google.script.run.withSuccessHandler(d => { 
        hideLoading(); 
        Swal.fire('å®Œäº†', d.count + 'ä»¶', 'success'); 
        loadMainData(); 
      }).importUnitJson(document.getElementById('ji').value); 
    } 
  });
}


// ==========================================
//  6. Utilities
// ==========================================

function showToast(icon, title) {
  Swal.fire({ toast: true, position: 'top-end', icon: icon, title: title, timer: 2000, showConfirmButton: false });
}

function handleError(err) {
  hideLoading();
  Swal.fire({ title: 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼', text: err.message || err.toString(), icon: 'error' });
}

function showLoading() { const e = document.getElementById('loading'); if (e) e.classList.remove('d-none'); }
function hideLoading() { const e = document.getElementById('loading'); if (e) e.classList.add('d-none'); }

function toggleSettings() { 
  if (document.getElementById('settingsModal')) {
    new bootstrap.Modal(document.getElementById('settingsModal')).show();
    unlockAudio();
  }
}

function toggleDarkMode() {
  const isDark = document.getElementById('darkModeSwitch').checked;
  if (isDark) { document.body.setAttribute('data-theme', 'dark'); localStorage.setItem(CONSTANTS.LS_KEY_THEME, 'dark'); }
  else { document.body.removeAttribute('data-theme'); localStorage.setItem(CONSTANTS.LS_KEY_THEME, 'light'); }
}

function toggleSound() {
  appState.sound.enabled = document.getElementById('soundSwitch').checked;
  if (appState.sound.enabled) unlockAudio();
}

function unlockAudio() {
  const audio = document.getElementById('sos-chime');
  if (audio && !appState.sound.unlocked) {
    audio.volume = 0;
    audio.play().then(() => { 
      audio.pause(); 
      audio.currentTime = 0; 
      audio.volume = 0.5; 
      appState.sound.unlocked = true; 
    }).catch(e => {});
  }
}

function checkSosAndPlaySound() {
  if (!appState.sound.enabled) return;
  const currentSosCount = dataStore.liveStatus.filter(d => d.mode === 'ãŸã™ã‘ã¦').length;
  if (currentSosCount > appState.sound.prevSosCount) {
    const audio = document.getElementById('sos-chime');
    if (audio) audio.play().catch(e => { showToast('warning', 'SOSå—ä¿¡ (éŸ³å£°ãƒ–ãƒ­ãƒƒã‚¯)'); });
  }
  appState.sound.prevSosCount = currentSosCount;
}
</script>
