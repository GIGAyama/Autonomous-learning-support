<script>
/**
 * ğŸ§­ ã¿ã‚‰ã„ã‚³ãƒ³ãƒ‘ã‚¹ Ver. 1.0 - Teacher Logic (å…ˆç”Ÿç”¨æ©Ÿèƒ½)
 * ==============================================================================
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼ˆç®¡ç†ç”»é¢ï¼‰ã®å‹•ä½œã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
 * ãƒ»èªè¨¼ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªï¼‰
 * ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆLIVEãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€åº§å¸­è¡¨ã€ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã€ã¾ã¨ã‚ä¸€è¦§ï¼‰
 * ãƒ»å˜å…ƒè¨­è¨ˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã®è¨ˆç”»ä½œæˆã€AIã«ã‚ˆã‚‹æ¡ˆä½œæˆï¼‰
 * ãƒ»æˆæ¥­ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…ä¿¡ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
 * ãƒ»åç°¿ç®¡ç†
 */

// ==========================================
//  1. èªè¨¼ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ (Authentication)
// ==========================================

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] å…ˆç”Ÿç”¨ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
 */
function attemptTeacherLogin() {
  Swal.fire({
    title: 'æ•™å“¡ç”¨ãƒ­ã‚°ã‚¤ãƒ³',
    input: 'password',
    inputAttributes: { autocapitalize: 'off' },
    showCancelButton: true,
    confirmButtonText: 'ãƒ­ã‚°ã‚¤ãƒ³',
    showLoaderOnConfirm: true,
    preConfirm: (pass) => {
      return new Promise((resolve, reject) => {
        // ã‚µãƒ¼ãƒãƒ¼ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç…§åˆ
        google.script.run
          .withSuccessHandler(res => {
            if (res.authenticated) {
              resolve(true); 
            } else {
              Swal.showValidationMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
              resolve(false); 
            }
          })
          .withFailureHandler(e => { Swal.showValidationMessage(e.message); resolve(false); })
          .verifyPassword(pass);
      });
    }
  }).then((result) => {
    if (result.isConfirmed) {
      switchMode('teacher'); // ã‚³ã‚¢æ©Ÿèƒ½ã§ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
      showToast('success', 'å…ˆç”Ÿãƒ¢ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
    }
  });
}

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
 */
function changePasswordPrompt() {
  Swal.fire({
    title: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´',
    input: 'text',
    inputLabel: 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›',
    showCancelButton: true,
    confirmButtonText: 'å¤‰æ›´'
  }).then(r => {
    if (r.isConfirmed && r.value) {
      google.script.run
        .withSuccessHandler(() => Swal.fire('å®Œäº†', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success'))
        .changeTeacherPassword(r.value);
    }
  });
}

// ==========================================
//  2. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º (Dashboard Views)
// ==========================================

/**
 * [ç”»é¢æç”»] å…ˆç”Ÿç”¨ãƒ¡ã‚¤ãƒ³ç”»é¢ã®æ çµ„ã¿
 */
function renderTeacherView() {
  const container = document.getElementById('app-container');
  
  // ã‚¯ãƒ©ã‚¹åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ–ã®ç”Ÿæˆ
  const classes = ['All', ...dataStore.classList];
  const tabsHtml = classes.map(c => 
    `<li class="nav-item"><a class="nav-link ${appState.view.teacherClassId === c ? 'active fw-bold' : ''}" href="#" onclick="setTeacherClass('${c}')">${c === 'All' ? 'å…¨å“¡' : c}</a></li>`
  ).join('');

  container.innerHTML = `
    <div class="card shadow-sm p-4 border-0 rounded-4 teacher-view-card h-100">
      <!-- ä¸Šéƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ç¾¤ -->
      <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
        <h5 class="fw-bold m-0 text-primary"><i class="bi bi-speedometer2 me-2"></i>ãƒ¢ãƒ‹ã‚¿ãƒ¼ <span class="badge bg-success ms-2 small" style="font-size:0.6rem">AUTO</span></h5>
        <div class="d-flex gap-3 align-items-center">
          <div class="btn-group shadow-sm rounded-pill" role="group">
            <button class="btn btn-sm ${appState.view.teacher === 'cards' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('cards')">LIVE</button>
            <button class="btn btn-sm ${appState.view.teacher === 'heatmap' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('heatmap')">ä¸€è¦§</button>
            <button class="btn btn-sm ${appState.view.teacher === 'seating' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('seating')">åº§å¸­</button>
            <button class="btn btn-sm ${appState.view.teacher === 'summaries' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('summaries')">ã¾ã¨ã‚</button>
            <button class="btn btn-sm ${appState.view.teacher === 'design' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('design')"><i class="bi bi-pencil-ruler me-1"></i>è¨­è¨ˆ</button>
            <button class="btn btn-sm ${appState.view.teacher === 'control' ? 'btn-primary' : 'btn-outline-primary'}" onclick="setTeacherView('control')">é€²è¡Œ</button>
          </div>
          <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="openUnitManagerModal()"><i class="bi bi-plus-circle me-1"></i>æ–°è¦å˜å…ƒç™»éŒ²</button>
        </div>
      </div>
      
      <!-- ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ– -->
      <ul class="nav nav-tabs mb-4 border-bottom-0 flex-shrink-0">${tabsHtml}</ul>
      
      <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
      <div id="t-area" class="position-relative flex-grow-1 d-flex flex-column overflow-hidden"></div>
    </div>`;
    
  renderTeacherDashboardContent(); // ä¸­èº«ã‚’æç”»
}

// ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ˜ãƒ«ãƒ‘ãƒ¼
function setTeacherClass(cls) { appState.view.teacherClassId = cls; renderTeacherView(); }
function setTeacherView(mode) { appState.view.teacher = mode; renderTeacherView(); }

/**
 * [ç”»é¢æç”»] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä¸­èº«ã‚’æŒ¯ã‚Šåˆ†ã‘
 */
function renderTeacherDashboardContent() {
  const el = document.getElementById('t-area');
  if (!el) return;
  
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®ç¶­æŒ
  const scrollPos = el.scrollTop;
  
  // è¨­è¨ˆç”»é¢(design)ã®æ™‚ã ã‘ã€å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã¦ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã‚’ã—ã‚„ã™ãã™ã‚‹
  const mainEl = document.querySelector('main');
  const appContainer = document.getElementById('app-container');
  if (mainEl && appContainer) {
    if (appState.view.teacher === 'design') {
      mainEl.style.overflow = 'hidden';        
      mainEl.style.display = 'flex';            
      mainEl.style.flexDirection = 'column';
      mainEl.style.paddingBottom = '0';
      appContainer.classList.add('h-100');
      appContainer.style.overflow = 'hidden';
    } else {
      mainEl.style.overflow = '';
      mainEl.style.display = '';
      mainEl.style.flexDirection = '';
      mainEl.style.paddingBottom = ''; 
      appContainer.classList.remove('h-100');
      appContainer.style.overflow = '';
    }
  }

  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸé–¢æ•°å‘¼ã³å‡ºã—
  if (appState.view.teacher === 'summaries') { renderSummaryListView(el); if(scrollPos>0) el.scrollTop = scrollPos; return; }
  if (appState.view.teacher === 'seating') { renderSeatingView(el); return; }
  if (appState.view.teacher === 'control') { renderControlView(el); return; }
  if (appState.view.teacher === 'design') { renderTeacherDesignView(el); return; } 
  
  const targetStudents = getFilteredStudents();
  if (appState.view.teacher === 'cards') {
    renderLiveCards(el, targetStudents);
  } else {
    renderHeatmap(el, targetStudents);
  }
  
  if(appState.view.teacher !== 'design' && scrollPos > 0) el.scrollTop = scrollPos;
}

/**
 * [ãƒ‡ãƒ¼ã‚¿å‡¦ç†] è¡¨ç¤ºå¯¾è±¡ã®ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
 */
function getFilteredStudents() {
  if (appState.view.teacherClassId === 'All') return dataStore.liveStatus;
  return dataStore.liveStatus.filter(s => s.classId === appState.view.teacherClassId);
}

/**
 * [é«˜é€Ÿæ›´æ–°] è‡ªå‹•æ›´æ–°æ™‚ã«ç”»é¢å…¨ä½“ã‚’å†æç”»ã›ãšã€ã‚«ãƒ¼ãƒ‰ã®è‰²ã‚„æ–‡å­—ã ã‘æ›¸ãæ›ãˆã‚‹
 */
function updateLiveViews() {
  const students = getFilteredStudents();
  
  // LIVEãƒ“ãƒ¥ãƒ¼ã®å ´åˆ
  if (appState.view.teacher === 'cards') {
    students.forEach(s => {
      const card = document.getElementById(`live-card-${s.name}`);
      if (card) {
        const isSos = (s.mode === 'ãŸã™ã‘ã¦' || s.mode === 'sos');
        const isFocus = (s.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' || s.mode === 'focus');
        const isOtherUnit = s.currentUnitId && s.currentUnitId !== appState.unit.id;
        
        // ã‚¯ãƒ©ã‚¹ã®ä»˜ã‘æ›¿ãˆ
        card.className = `card h-100 text-center p-3 shadow-sm border-0 rounded-4 ${isSos ? 'sos-alert bg-light-danger border-danger' : ''} ${isFocus ? 'border-info' : ''}`;
        card.style.opacity = isOtherUnit ? '0.5' : '1';
        
        // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
        const icon = card.querySelector('.bi-person-circle');
        if (icon) {
          icon.className = `bi bi-person-circle fs-1 my-2 ${isSos ? 'text-danger' : (isFocus ? 'text-info' : 'text-secondary')}`;
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
        const taskEl = card.querySelector('.task-text');
        if (taskEl) taskEl.innerHTML = isOtherUnit ? '<span class="small text-secondary">ä»–å˜å…ƒã‚’å­¦ç¿’ä¸­</span>' : (s.task || '-');
        
        const badgeEl = card.querySelector('.mode-badge');
        if (badgeEl) badgeEl.textContent = s.mode || 'é€šå¸¸';
      }
    });
  }
  
  // åº§å¸­è¡¨ãƒ“ãƒ¥ãƒ¼ã®å ´åˆ
  else if (appState.view.teacher === 'seating' && !isDraggingSeat) {
    const canvas = document.getElementById('seating-canvas');
    if (canvas) {
      students.forEach(s => {
        const card = canvas.querySelector(`.seat-card[data-name="${s.name}"]`);
        if (card) {
          const isSos = (s.mode === 'ãŸã™ã‘ã¦' || s.mode === 'sos');
          const isFocus = (s.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' || s.mode === 'focus');
          
          if (isSos) card.classList.add('sos-alert', 'bg-light-danger');
          else card.classList.remove('sos-alert', 'bg-light-danger');
          
          const icon = card.querySelector('.bi-person-circle');
          if (icon) icon.className = `bi bi-person-circle fs-3 ${isSos ? 'text-danger' : (isFocus ? 'text-info' : 'text-secondary')}`;
          
          const taskDiv = card.querySelector('.x-small');
          if(taskDiv) taskDiv.textContent = s.task || '-';
        }
      });
    }
  }
}

// ==========================================
//  3. å„ãƒ“ãƒ¥ãƒ¼ã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ (View Implementations)
// ==========================================

/**
 * [LIVEãƒ“ãƒ¥ãƒ¼] ã‚«ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º
 */
function renderLiveCards(container, students) {
  container.className = "flex-grow-1 overflow-auto"; 
  if (students.length === 0) {
    container.innerHTML = `<div class="text-muted p-5 text-center">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
  } else {
    container.innerHTML = `<div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-3">${students.map(s => {
      const isOtherUnit = s.currentUnitId && s.currentUnitId !== appState.unit.id;
      const opacity = isOtherUnit ? '0.5' : '1';
      const taskDisplay = isOtherUnit ? '<span class="small text-secondary">ä»–å˜å…ƒã‚’å­¦ç¿’ä¸­</span>' : (s.task || '-');
      const isSos = (s.mode === 'ãŸã™ã‘ã¦' || s.mode === 'sos');
      const isFocus = (s.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' || s.mode === 'focus');
      
      return `
      <div class="col">
        <div id="live-card-${s.name}" class="card h-100 text-center p-3 shadow-sm border-0 rounded-4 ${isSos ? 'sos-alert bg-light-danger border-danger' : ''} ${isFocus ? 'border-info' : ''}" style="opacity: ${opacity}">
          <div class="fw-bold text-truncate mb-2">${s.name}</div>
          <i class="bi bi-person-circle fs-1 my-2 ${isSos ? 'text-danger' : (isFocus ? 'text-info' : 'text-secondary')}"></i>
          <div class="small text-muted text-truncate task-text">${taskDisplay}</div>
          <div class="badge bg-light text-muted mt-1 fw-normal mode-badge">${s.mode || 'é€šå¸¸'}</div>
        </div>
      </div>`;
    }).join('')}</div>`;
  }
}

/**
 * [ä¸€è¦§ãƒ“ãƒ¥ãƒ¼] ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆé€²æ—ä¸€è¦§è¡¨ï¼‰
 */
function renderHeatmap(container, students) {
  container.className = "flex-grow-1 overflow-auto";
  const currentTasks = getCurrentUnitTasks();
  if (currentTasks.length === 0) { container.innerHTML = `<div class="text-center p-5">ã“ã®å˜å…ƒã®èª²é¡Œãƒ‡ãƒ¼ã‚¿ãªã—</div>`; return; }
  
  const studentNames = students.map(s => s.name).sort();
  if (studentNames.length === 0) { container.innerHTML = `<div class="text-center p-5">ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ãªã—</div>`; return; }

  let h = `<div class="table-responsive mb-4"><table class="table table-borderless heatmap-table"><thead><tr><th style="min-width:100px;text-align:left">åå‰</th>${currentTasks.map((t, i) => `<th title="${t.title}" onclick="showTeacherTaskDetailSimple('${t.taskId}')">${t.step ? t.step.replace(/[^0-9]/g, '') : i + 1}</th>`).join('')}</tr></thead><tbody>`;
  
  studentNames.forEach(n => {
    const st = dataStore.liveStatus.find(d => d.name === n);
    const isSos = st && (st.mode === 'ãŸã™ã‘ã¦' || st.mode === 'sos');
    const isFocus = st && (st.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' || st.mode === 'focus');
    const ic = isSos ? '<i class="bi bi-exclamation-circle-fill text-danger ms-1 animate__animated animate__flash"></i>' : (isFocus ? '<i class="bi bi-lightning-fill text-info ms-1"></i>' : '');
    
    // ç”Ÿå¾’åã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªè¡¨ç¤º
    h += `<tr><td class="text-start fw-bold text-truncate" style="max-width:120px;cursor:pointer;text-decoration:underline" onclick="renderPortfolioModal('${n}', true)">${n}${ic}</td>`;
    
    currentTasks.forEach(t => {
      const p = (dataStore.clsProgress[n] && dataStore.clsProgress[n][t.taskId]) || {};
      const stamp = (dataStore.clsFeedback[n] && dataStore.clsFeedback[n][t.taskId]);
      
      let cls = "", icon = "";
      if (p.status === 'å®Œäº†') cls = "heatmap-done";
      else if (p.status === 'é€”ä¸­') cls = "heatmap-doing";
      else if (isSos) cls = "heatmap-sos"; // SOSä¸­ã¯æœªå®Œäº†ã‚»ãƒ«ã‚’ç‚¹æ»…ã•ã›ã‚‹
      else if (isFocus) cls = "heatmap-focus";
      
      if (stamp) { if(stamp==='check') icon='âœ…'; if(stamp==='good') icon='ğŸ‘'; if(stamp==='great') icon='ğŸ’®'; if(stamp==='support') icon='ğŸš©'; }
      
      h += `<td><div class="heatmap-cell-wrapper" onclick="showStudentTaskDetail('${n}', '${t.taskId}')"><div class="heatmap-cell ${cls}" title="${t.title}">${icon}</div></div></td>`;
    });
    h += '</tr>';
  });
  
  // èª²é¡Œã®å‡¡ä¾‹
  const indexHtml = `<div class="card bg-light border-0 rounded-4 p-3 mt-3"><h6 class="fw-bold text-muted mb-2"><i class="bi bi-list-ol me-2"></i>èª²é¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ${appState.unit.title}ï¼‰</h6><div class="row row-cols-1 row-cols-md-2 g-2 small">${currentTasks.map((t, i) => `<div class="col" style="cursor:pointer" onclick="showTeacherTaskDetailSimple('${t.taskId}')"><span class="badge bg-secondary me-2" style="width:25px;">${t.step ? t.step.replace(/[^0-9]/g, '') : i + 1}</span><span class="badge bg-white text-dark border me-1">${t.category}</span><span class="text-truncate d-inline-block" style="max-width:200px;vertical-align:middle">${t.title}</span></div>`).join('')}</div></div>`;
  container.innerHTML = h + '</tbody></table></div>' + indexHtml;
}

/**
 * [åº§å¸­ãƒ“ãƒ¥ãƒ¼] ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªåº§å¸­è¡¨
 */
function renderSeatingView(container) {
  const students = getFilteredStudents();
  if (students.length === 0) {
    container.innerHTML = `<div class="text-center p-5 text-muted">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }

  container.className = "flex-grow-1 d-flex flex-column overflow-hidden";
  container.innerHTML = `
    <div class="d-flex justify-content-between mb-2 flex-shrink-0">
      <div class="small text-muted"><i class="bi bi-info-circle me-1"></i>ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åº§å¸­ã‚’é…ç½®ã§ãã¾ã™ï¼ˆã‚°ãƒªãƒƒãƒ‰å¸ç€ã‚ã‚Šï¼‰</div>
      <!-- [ä¿®æ­£] ãƒœã‚¿ãƒ³ã«IDã‚’è¿½åŠ ã—ã¦æ“ä½œå¯èƒ½ã« -->
      <button id="btn-save-seating" class="btn btn-primary btn-sm rounded-pill px-3" onclick="saveSeating()">é…ç½®ã‚’ä¿å­˜</button>
    </div>
    <div class="seating-wrapper border rounded-4 bg-light shadow-inner flex-grow-1 position-relative overflow-hidden">
       <div id="seating-canvas" class="seating-canvas position-absolute top-0 start-0 w-100 h-100 overflow-auto">
         <!-- Cards will be injected here -->
       </div>
    </div>`;

  const canvas = document.getElementById('seating-canvas');
  
  students.forEach(s => {
    const x = s.x || 50;
    const y = s.y || 50;
    const isSos = (s.mode === 'ãŸã™ã‘ã¦' || s.mode === 'sos');
    const isFocus = (s.mode === 'ã—ã‚…ã†ã¡ã‚…ã†' || s.mode === 'focus');
    
    const card = document.createElement('div');
    card.className = `card shadow-sm seat-card position-absolute ${isSos ? 'sos-alert' : ''}`;
    card.style.left = x + 'px';
    card.style.top = y + 'px';
    card.style.width = '100px';
    card.setAttribute('data-name', s.name);
    
    card.innerHTML = `
      <div class="card-body p-2 text-center" style="cursor: move;" onmousedown="startDragSeat(event, this)" ontouchstart="startDragSeat(event, this)">
        <div class="fw-bold text-truncate small mb-1">${s.name}</div>
        <i class="bi bi-person-circle fs-3 ${isSos ? 'text-danger' : (isFocus ? 'text-info' : 'text-secondary')}"></i>
        <div class="x-small text-muted text-truncate mt-1">${s.task || '-'}</div>
      </div>
    `;
    canvas.appendChild(card);
  });
}

// åº§å¸­ãƒ‰ãƒ©ãƒƒã‚°ã®å‡¦ç†ï¼ˆã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒŠãƒƒãƒ—ä»˜ãï¼‰
let dragSrcEl = null;
let isDraggingSeat = false;
let dragStartX = 0; // [è¿½åŠ ] ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®Xåº§æ¨™
let dragStartY = 0; // [è¿½åŠ ] ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®Yåº§æ¨™

function startDragSeat(e, cardBody) {
  e.preventDefault(); 
  const card = cardBody.parentElement;
  dragSrcEl = card;
  isDraggingSeat = true;
  
  const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
  
  // [è¿½åŠ ] é–‹å§‹ä½ç½®ã‚’è¨˜éŒ²
  dragStartX = parseInt(card.style.left, 10) || 0;
  dragStartY = parseInt(card.style.top, 10) || 0;
  
  const shiftX = clientX - card.getBoundingClientRect().left;
  const shiftY = clientY - card.getBoundingClientRect().top;
  
  const canvas = document.getElementById('seating-canvas');
  const canvasRect = canvas.getBoundingClientRect();

  function moveAt(pageX, pageY) {
    let newLeft = pageX - shiftX - canvasRect.left;
    let newTop = pageY - shiftY - canvasRect.top;
    
    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;
    if (newLeft > canvasRect.width - card.offsetWidth) newLeft = canvasRect.width - card.offsetWidth;
    if (newTop > canvasRect.height - card.offsetHeight) newTop = canvasRect.height - card.offsetHeight;

    card.style.left = newLeft + 'px';
    card.style.top = newTop + 'px';
  }

  function onMouseMove(e) {
    const px = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const py = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    moveAt(px, py);
  }

  function onMouseUp() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    document.removeEventListener('touchmove', onMouseMove);
    document.removeEventListener('touchend', onMouseUp);
    
    // ã‚°ãƒªãƒƒãƒ‰ã«å¸ç€
    const GRID = CONSTANTS.SEAT_GRID_SIZE;
    const currentLeft = parseInt(card.style.left, 10);
    const currentTop = parseInt(card.style.top, 10);
    
    const snapLeft = Math.round(currentLeft / GRID) * GRID + 10;
    const snapTop = Math.round(currentTop / GRID) * GRID + 10;
    
    // [è¿½åŠ ] é‡ãªã‚Šãƒã‚§ãƒƒã‚¯
    if (checkCollision(card, snapLeft, snapTop)) {
        // é‡ãªã£ã¦ã„ã‚‹ã®ã§å…ƒã®ä½ç½®ã«æˆ»ã™
        card.style.transition = 'all 0.2s ease-out';
        card.style.left = dragStartX + 'px';
        card.style.top = dragStartY + 'px';
        showToast('warning', 'ãã“ã«ã‚«ãƒ¼ãƒ‰ã¯ç½®ã‘ã¾ã›ã‚“');
    } else {
        // ç§»å‹•ç¢ºå®š
        card.style.transition = 'all 0.2s ease-out';
        card.style.left = snapLeft + 'px';
        card.style.top = snapTop + 'px';
    }
    
    setTimeout(() => { card.style.transition = ''; }, 200);

    dragSrcEl = null;
    isDraggingSeat = false;
  }

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
  document.addEventListener('touchmove', onMouseMove, {passive: false});
  document.addEventListener('touchend', onMouseUp);
}

// [è¿½åŠ ] è¡çªåˆ¤å®šé–¢æ•°
function checkCollision(targetCard, x, y) {
    const cards = document.querySelectorAll('.seat-card');
    for (let i = 0; i < cards.length; i++) {
        const other = cards[i];
        if (other === targetCard) continue; // è‡ªåˆ†è‡ªèº«ã¯ã‚¹ã‚­ãƒƒãƒ—
        
        const otherX = parseInt(other.style.left, 10);
        const otherY = parseInt(other.style.top, 10);
        
        // è¨±å®¹èª¤å·®ã‚’å«ã‚ã¦åˆ¤å®šï¼ˆã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºæœªæº€ã®è·é›¢ãªã‚‰é‡ãªã‚Šã¨ã¿ãªã™ï¼‰
        const dist = Math.sqrt(Math.pow(x - otherX, 2) + Math.pow(y - otherY, 2));
        if (dist < CONSTANTS.SEAT_GRID_SIZE / 2) {
            return true;
        }
    }
    return false;
}

function saveSeating() {
  // [ä¿®æ­£] ãƒœã‚¿ãƒ³ã®å–å¾—ã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã¸ã®å¤‰æ›´
  const btn = document.getElementById('btn-save-seating');
  const originalText = btn ? btn.innerHTML : 'é…ç½®ã‚’ä¿å­˜';
  
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>ä¿å­˜ä¸­...';
  }

  const cards = document.querySelectorAll('.seat-card');
  const coords = [];
  cards.forEach(c => {
    coords.push({
      name: c.getAttribute('data-name'),
      x: parseInt(c.style.left, 10),
      y: parseInt(c.style.top, 10)
    });
  });
  
  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'åº§å¸­é…ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      
      // [è¿½åŠ ] ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚‚æ›´æ–°ã—ã¦ã€ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆç­‰ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
      coords.forEach(c => {
        const student = dataStore.liveStatus.find(s => s.name === c.name);
        if (student) {
          student.x = c.x;
          student.y = c.y;
        }
      });

      // [ä¿®æ­£] å‡¦ç†æˆåŠŸæ™‚ã«ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    })
    .withFailureHandler((e) => {
      handleError(e);
      // [ä¿®æ­£] ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    })
    .saveSeatCoordinates(coords);
}

/**
 * [ã¾ã¨ã‚ãƒ“ãƒ¥ãƒ¼] ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªä¸€è¦§ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
 */
function renderSummaryListView(container) {
  container.className = "flex-grow-1 p-3 overflow-hidden d-flex flex-column"; 
  
  const students = getFilteredStudents().sort((a,b) => a.name.localeCompare(b.name));
  
  if (students.length === 0) {
    container.innerHTML = `<div class="text-center p-5 text-muted">è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }

  let tableRows = '';
  students.forEach((s, index) => {
    // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿å–å¾—
    let pf = {};
    if (dataStore.clsPortfolios && dataStore.clsPortfolios[s.name] && dataStore.clsPortfolios[s.name][appState.unit.id]) {
      const rawPf = dataStore.clsPortfolios[s.name][appState.unit.id];
      pf = (typeof rawPf === 'object') ? rawPf : { summary: rawPf, feedback: "", stamp: "" };
    }
    const summary = pf.summary || "";
    const feedback = pf.feedback || "";
    const stamp = pf.stamp || "";

    // ã‚¹ã‚­ãƒ«é›†è¨ˆ
    const skillCounts = {};
    SKILL_DEFINITIONS.forEach(def => skillCounts[def.id] = 0);
    
    if (dataStore.clsReflections && dataStore.clsReflections[s.name] && dataStore.clsReflections[s.name][appState.unit.id]) {
      const reflections = dataStore.clsReflections[s.name][appState.unit.id];
      Object.values(reflections).forEach(r => {
        if (r.skills && Array.isArray(r.skills)) {
          r.skills.forEach(sid => { if (skillCounts[sid] !== undefined) skillCounts[sid]++; });
        }
      });
    }

    // ã‚¹ã‚­ãƒ«ãƒãƒƒã‚¸HTMLç”Ÿæˆ
    let skillBadges = '';
    SKILL_DEFINITIONS.forEach(def => {
      const count = skillCounts[def.id];
      if (count > 0) {
        skillBadges += `<span class="skill-mini-badge bg-${def.color}" title="${def.label}: ${count}å›">${def.label.charAt(0)}${count}</span>`;
      }
    });
    if (!skillBadges) skillBadges = '<span class="text-muted small">-</span>';

    const uniqueId = `pf-${index}`;

    tableRows += `
      <tr>
        <td class="st-col-name text-center text-muted small align-middle">${index + 1}</td>
        <td class="st-col-name align-middle">
          <div class="fw-bold text-primary" style="cursor:pointer;" onclick="renderPortfolioModal('${s.name}', true)">
            ${s.name} <i class="bi bi-box-arrow-up-right small ms-1 text-muted"></i>
          </div>
        </td>
        <td class="st-col-skills align-middle">
          <div class="skill-badge-group">${skillBadges}</div>
        </td>
        <td class="st-col-summary">
          <div class="summary-text-area" id="summary-${uniqueId}" onclick="this.style.maxHeight='none'; this.style.cursor='text';" title="ã‚¯ãƒªãƒƒã‚¯ã§å…¨æ–‡è¡¨ç¤º">
            ${summary ? summary.replace(/\n/g, '<br>') : '<span class="summary-empty">æœªæå‡º</span>'}
          </div>
        </td>
        <td class="st-col-feedback align-middle">
          <div class="stamp-select-group">
            <label><input type="radio" name="stamp-${uniqueId}" value="check" class="stamp-input" ${stamp==='check'?'checked':''}><span class="stamp-option" title="ç¢ºèª">âœ…</span></label>
            <label><input type="radio" name="stamp-${uniqueId}" value="good" class="stamp-input" ${stamp==='good'?'checked':''}><span class="stamp-option" title="ã„ã„ã­">ğŸ‘</span></label>
            <label><input type="radio" name="stamp-${uniqueId}" value="great" class="stamp-input" ${stamp==='great'?'checked':''}><span class="stamp-option" title="ã™ã°ã‚‰ã—ã„">ğŸ’®</span></label>
            <label><input type="radio" name="stamp-${uniqueId}" value="support" class="stamp-input" ${stamp==='support'?'checked':''}><span class="stamp-option" title="å¿œæ´">ğŸš©</span></label>
          </div>
          <div class="input-group input-group-sm">
            <input type="text" id="fb-text-${uniqueId}" class="form-control" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." value="${feedback}">
            <button id="btn-save-${uniqueId}" class="btn btn-primary" onclick="saveListFeedback('${s.name}', '${uniqueId}')">ä¿å­˜</button>
          </div>
        </td>
      </tr>`;
  });

  container.innerHTML = `
    <div class="summary-table-container h-100">
      <table class="summary-table">
        <thead>
          <tr>
            <th class="text-center" style="width:40px;">#</th>
            <th class="st-col-name">åå‰</th>
            <th class="st-col-skills">ç²å¾—ã‚¹ã‚­ãƒ«</th>
            <th class="st-col-summary">å˜å…ƒã®ã¾ã¨ã‚</th>
            <th class="st-col-feedback">
              <div class="d-flex justify-content-between align-items-center">
                <span>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
                <button id="btn-bulk-save" class="btn btn-success btn-sm rounded-pill px-3 shadow-sm" onclick="saveAllListFeedbacks()">
                  <i class="bi bi-save me-1"></i>ä¸€æ‹¬ä¿å­˜
                </button>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
    </div>`;
}

function saveListFeedback(studentName, uniqueId) {
  const comment = document.getElementById(`fb-text-${uniqueId}`).value;
  const stampEl = document.querySelector(`input[name="stamp-${uniqueId}"]:checked`);
  const stamp = stampEl ? stampEl.value : "";
  
  const btn = document.getElementById(`btn-save-${uniqueId}`);
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '...';
  
  // ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜
  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'ä¿å­˜ã—ã¾ã—ãŸ');
      btn.disabled = false;
      btn.innerHTML = originalText;
    })
    .withFailureHandler((e) => {
      handleError(e);
      btn.disabled = false;
      btn.innerHTML = originalText;
    })
    .savePortfolioFeedback(studentName, appState.unit.id, comment, stamp);
}

function saveAllListFeedbacks() {
  const students = getFilteredStudents();
  if (students.length === 0) return;

  const btn = document.getElementById('btn-bulk-save');
  const originalHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ä¿å­˜ä¸­...';

  const feedbackList = [];
  students.forEach((s, index) => {
    const uniqueId = `pf-${index}`;
    const commentInput = document.getElementById(`fb-text-${uniqueId}`);
    const stampEl = document.querySelector(`input[name="stamp-${uniqueId}"]:checked`);
    
    if (commentInput) {
      feedbackList.push({
        studentName: s.name,
        unitId: appState.unit.id,
        feedback: commentInput.value,
        stamp: stampEl ? stampEl.value : ""
      });
    }
  });

  google.script.run
    .withSuccessHandler(() => {
      showToast('success', 'å…¨å“¡åˆ†ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    })
    .withFailureHandler((e) => {
      handleError(e);
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    })
    .saveAllPortfolios(feedbackList);
}

// ==========================================
//  4. å˜å…ƒè¨­è¨ˆãƒ»ç®¡ç† (Unit Design)
// ==========================================

/**
 * [è¨­è¨ˆç”»é¢] ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§æˆæ¥­è¨ˆç”»ã‚’ç«‹ã¦ã‚‹
 */
function renderTeacherDesignView(container) {
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®ä¿å­˜
  const poolContainer = document.getElementById('teacher-pool-container');
  const poolScrollY = poolContainer ? poolContainer.scrollTop : 0;
  const designScrollContainer = document.getElementById('teacher-design-scroll-view');
  const designScrollY = designScrollContainer ? designScrollContainer.scrollTop : 0;

  container.className = "d-flex flex-column flex-grow-1 overflow-hidden h-100";
  container.style.height = "100%";
  
  const currentTasks = getCurrentUnitTasks(); 
  const totalHours = appState.unit.totalHours; 
  
  const taskPool = [];
  const hoursMap = {}; 
  
  for(let i = 1; i <= totalHours; i++) hoursMap[i] = [];
  
  currentTasks.forEach(t => {
    const stepNum = getStepNumber(t.step);
    if (stepNum > 0 && hoursMap[stepNum]) {
      hoursMap[stepNum].push(t);
    } else {
      taskPool.push(t);
    }
  });

  // æœªé…ç½®ãƒ—ãƒ¼ãƒ«ã®ã‚«ãƒ¼ãƒ‰HTMLç”Ÿæˆ
  let taskPoolHtml = '';
  taskPool.forEach(t => {
    const borderClass = getCategoryColorClass(t.category);
    const badge = t.format === 'teacher' ? '<span class="badge bg-info text-white me-1">å…ˆç”Ÿ</span>' : '';
    taskPoolHtml += `
      <div class="card p-2 mb-2 shadow-sm task-draggable ${borderClass}" data-id="${t.taskId}" onclick="openTeacherTaskEditModal('${t.taskId}')" style="cursor:pointer">
        <div class="small fw-bold">${badge}${t.title}</div>
        <div class="d-flex justify-content-between align-items-center mt-1">
          <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
          <div class="x-small text-muted">${t.time}åˆ†</div>
        </div>
      </div>`;
  });

  // æ™‚æ•°ãƒ¬ãƒ¼ãƒ³ã®ã‚«ãƒ¼ãƒ‰HTMLç”Ÿæˆ
  let hoursHtml = '';
  for(let i = 1; i <= totalHours; i++) {
    let hourTasksHtml = '';
    let totalTime = 0;
    
    hoursMap[i].forEach(t => {
      totalTime += t.time;
      const borderClass = getCategoryColorClass(t.category);
      const badge = t.format === 'teacher' ? '<span class="badge bg-info text-white me-1">å…ˆç”Ÿ</span>' : '';
      hourTasksHtml += `
        <div class="card p-2 mb-2 shadow-sm task-draggable ${borderClass}" data-id="${t.taskId}" onclick="openTeacherTaskEditModal('${t.taskId}')" style="cursor:pointer">
          <div class="d-flex justify-content-between">
            <span class="small fw-bold text-truncate">${badge}${t.title}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-1">
            <span class="badge bg-light text-secondary border rounded-pill" style="font-size:0.6rem">${t.category}</span>
            <div class="x-small text-muted text-end">${t.time}åˆ†</div>
          </div>
        </div>`;
    });

    const timeRatio = Math.min(totalTime / CONSTANTS.UNIT_TIME, 1) * 100;
    const barColor = totalTime > CONSTANTS.UNIT_TIME ? '#ffcdd2' : '#c8e6c9';
    const headerStyle = `background: linear-gradient(90deg, ${barColor} ${timeRatio}%, #f8f9fa ${timeRatio}%);`;

    hoursHtml += `
      <div class="plan-hour-row mb-3">
        <div class="plan-hour-header-v p-2 fw-bold text-center border rounded-top position-relative" style="${headerStyle}">
          ç¬¬${i}æ™‚ <span class="small ms-2 fw-normal badge bg-white text-dark border">${totalTime}åˆ†</span>
        </div>
        <div class="plan-drop-zone-v p-2 border border-top-0 rounded-bottom teacher-design-dropzone" data-step="Step ${i}" style="min-height: 80px; background-color: #fff;">
          ${hourTasksHtml}
        </div>
      </div>`;
  }

  // å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  container.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-3 p-3 pb-0 flex-shrink-0">
      <div class="d-flex align-items-center">
        <h5 class="fw-bold m-0 text-muted me-2">å˜å…ƒè¨ˆç”»</h5>
        <button class="btn btn-light btn-sm text-secondary rounded-circle me-3" onclick="openUnitInfoEditModal()" title="å˜å…ƒæƒ…å ±ã®ç·¨é›†">
          <i class="bi bi-pencil-fill"></i>
        </button>
        <div class="input-group input-group-sm w-auto me-3">
          <span class="input-group-text">å…¨</span>
          <input type="text" class="form-control text-center fw-bold" value="${totalHours}" style="width:50px;" readonly>
          <span class="input-group-text">æ™‚é–“</span>
          <button class="btn btn-outline-secondary" onclick="changeUnitTotalHours(1)"><i class="bi bi-plus-lg"></i></button>
          <button class="btn btn-outline-secondary" onclick="changeUnitTotalHours(-1)"><i class="bi bi-dash-lg"></i></button>
        </div>
        <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="syncUnitToPassport()" title="ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã§ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ">
          <i class="bi bi-rocket-takeoff-fill me-2"></i>WSä½œæˆé€£æº
        </button>
      </div>
    </div>
    
    <div class="row flex-grow-1 px-3 pb-3 mx-0" style="min-height:0; overflow:hidden;">
      <div class="col-4 h-100 p-0 d-flex flex-column border-end bg-white rounded-start overflow-hidden">
        <div class="p-2 border-bottom fw-bold text-muted d-flex justify-content-between align-items-center flex-shrink-0">
          <span><i class="bi bi-inbox me-2"></i>æœªé…ç½®ãƒ»ãã®ä»–</span>
          <button class="btn btn-outline-primary btn-sm rounded-circle" onclick="openTeacherTaskEditModal('NEW')"><i class="bi bi-plus"></i></button>
        </div>
        <div id="teacher-pool-container" class="flex-grow-1 overflow-auto p-2 teacher-design-dropzone" data-step="">
          ${taskPoolHtml}
        </div>
      </div>
      <div class="col-8 h-100 p-0 d-flex flex-column bg-light rounded-end overflow-hidden">
        <div id="teacher-design-scroll-view" class="flex-grow-1 overflow-auto p-3">
          <div class="alert alert-info small py-2 mb-3"><i class="bi bi-info-circle me-2"></i>ã“ã“ã§ã®å¤‰æ›´ã¯<strong>å…¨å“¡ã®åˆæœŸè¨ˆç”»ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</strong>ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
          ${hoursHtml}
        </div>
      </div>
    </div>`;

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®å¾©å…ƒ
  if (document.getElementById('teacher-pool-container')) document.getElementById('teacher-pool-container').scrollTop = poolScrollY;
  if (document.getElementById('teacher-design-scroll-view')) document.getElementById('teacher-design-scroll-view').scrollTop = designScrollY;

  // Sortableè¨­å®š (ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—)
  const dropZones = document.querySelectorAll('.teacher-design-dropzone');
  dropZones.forEach(el => {
    new Sortable(el, {
      group: 'teacher-design',
      sort: true,
      animation: 150,
      onAdd: function (evt) {
        const taskId = evt.item.getAttribute('data-id');
        const newStep = evt.to.getAttribute('data-step') || ""; 
        
        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        const task = dataStore.masterTasks.find(t => t.taskId === taskId);
        if (task) {
          task.step = newStep;
          renderTeacherDesignView(document.getElementById('t-area')); 
          // ã‚µãƒ¼ãƒãƒ¼ä¿å­˜
          google.script.run
            .withFailureHandler(handleError)
            .updateUnitTask(taskId, { step: newStep });
        }
      }
    });
  });
}

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] ã‚¿ã‚¹ã‚¯ç·¨é›†ï¼ˆå…ˆç”Ÿç”¨ï¼‰
 */
function openTeacherTaskEditModal(taskId) {
  let task = {};
  let isNew = false;
  
  // æ•™æãƒªãƒ³ã‚¯æƒ…å ±ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
  const parseMat = (str) => { try { return JSON.parse(str||'{}'); } catch(e){ return {name:str,url:''}; } };
  const serializeMat = (name, url) => { if(!name&&!url)return ''; if(url&&url.trim()) return JSON.stringify({name,url}); return name; };

  if (taskId === 'NEW') {
    isNew = true;
    task = { title: '', description: '', estimatedTime: 15, category: 'ã¾ãªã¶', format: 'student', type: 'must', step: '' };
  } else {
    task = dataStore.masterTasks.find(t => t.taskId === taskId);
    if (!task) return;
  }

  const tb = parseMat(task.textbook);
  const tbTablet = parseMat(task.tablet);
  const tbPrint = parseMat(task.print);

  Swal.fire({
    title: isNew ? 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯' : 'ã‚¿ã‚¹ã‚¯ç·¨é›†',
    html: `
      <div class="text-start">
        <div class="mb-3">
          <label class="form-label small fw-bold">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="ed-title" class="form-control" value="${task.title || ''}">
        </div>
        <div class="mb-3">
          <label class="form-label small fw-bold">èª¬æ˜æ–‡</label>
          <textarea id="ed-desc" class="form-control" rows="2">${task.desc || task.description || ''}</textarea>
        </div>
        <div class="row mb-3">
          <div class="col">
            <label class="form-label small fw-bold">ç›®å®‰æ™‚é–“(åˆ†)</label>
            <input type="number" id="ed-time" class="form-control" value="${task.time || task.estimatedTime || 15}">
          </div>
          <div class="col">
            <label class="form-label small fw-bold">ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="ed-cat" class="form-select">
              <option value="ã¾ãªã¶" ${task.category==='ã¾ãªã¶'?'selected':''}>ã¾ãªã¶</option>
              <option value="ãµã‹ã‚ã‚‹" ${task.category==='ãµã‹ã‚ã‚‹'?'selected':''}>ãµã‹ã‚ã‚‹</option>
              <option value="ã¾ã¨ã‚ã‚‹" ${task.category==='ã¾ã¨ã‚ã‚‹'?'selected':''}>ã¾ã¨ã‚ã‚‹</option>
              <option value="å°å…¥" ${task.category==='å°å…¥'?'selected':''}>å°å…¥</option>
            </select>
          </div>
        </div>

        <div class="card p-2 bg-light border-0 mb-3">
          <div class="small fw-bold text-muted mb-2"><i class="bi bi-link-45deg"></i> å­¦ç¿’ãƒªãƒ³ã‚¯ãƒ»è³‡æ–™</div>
          <div class="mb-2">
            <label class="form-label x-small text-muted mb-0">æ•™ç§‘æ›¸ãƒ»è³‡æ–™</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="bi bi-book"></i></span>
              <input type="text" id="ed-tb-name" class="form-control" placeholder="åç§° (ä¾‹: P.24)" value="${tb.name||''}">
              <input type="text" id="ed-tb-url" class="form-control" placeholder="URL (ä»»æ„)" value="${tb.url||''}">
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label x-small text-muted mb-0">ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¢ãƒ—ãƒª</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="bi bi-tablet"></i></span>
              <input type="text" id="ed-tab-name" class="form-control" placeholder="åç§° (ä¾‹: NHK for School)" value="${tbTablet.name||''}">
              <input type="text" id="ed-tab-url" class="form-control" placeholder="URL (ä»»æ„)" value="${tbTablet.url||''}">
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label x-small text-muted mb-0">ãƒ—ãƒªãƒ³ãƒˆãƒ»ãã®ä»–</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="bi bi-file-earmark-text"></i></span>
              <input type="text" id="ed-pr-name" class="form-control" placeholder="åç§° (ä¾‹: ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆ)" value="${tbPrint.name||''}">
              <input type="text" id="ed-pr-url" class="form-control" placeholder="URL (ä»»æ„)" value="${tbPrint.url||''}">
            </div>
          </div>
        </div>

        <div class="mb-3 form-check form-switch border p-2 rounded bg-white">
          <input class="form-check-input ms-0 me-2" type="checkbox" id="ed-teacher" ${task.format === 'teacher' ? 'checked' : ''} style="float:none;">
          <label class="form-check-label fw-bold" for="ed-teacher">å…ˆç”Ÿã‚¿ã‚¹ã‚¯ï¼ˆå›ºå®šè¡¨ç¤ºï¼‰ã«ã™ã‚‹</label>
          <div class="form-text x-small ps-1">ONã«ã™ã‚‹ã¨ã€æŒ‡å®šã—ãŸæ™‚æ•°ã«è‡ªå‹•çš„ã«å›ºå®šè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>`,
    showCancelButton: true,
    confirmButtonText: 'ä¿å­˜',
    showDenyButton: !isNew,
    denyButtonText: 'å‰Šé™¤',
    denyButtonColor: '#d33',
    width: '550px',
    preConfirm: () => {
      const tbStr = serializeMat(document.getElementById('ed-tb-name').value, document.getElementById('ed-tb-url').value);
      const tabStr = serializeMat(document.getElementById('ed-tab-name').value, document.getElementById('ed-tab-url').value);
      const prStr = serializeMat(document.getElementById('ed-pr-name').value, document.getElementById('ed-pr-url').value);

      return {
        title: document.getElementById('ed-title').value,
        description: document.getElementById('ed-desc').value,
        estTime: parseInt(document.getElementById('ed-time').value),
        category: document.getElementById('ed-cat').value,
        format: document.getElementById('ed-teacher').checked ? 'teacher' : 'student',
        textbook: tbStr,
        tablet: tabStr,
        print: prStr
      };
    }
  }).then(r => {
    if (r.isConfirmed) {
      const newData = r.value;
      if (isNew) {
        // [ä¿®æ­£] æ¥½è¦³çš„UIæ›´æ–°: å³åº§ã«ç”»é¢ã«åæ˜ ã—ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚’è¡Œã†
        const tempId = "TEMP_" + new Date().getTime();
        const tempTask = {
            unitId: appState.unit.id,
            taskId: tempId,
            title: newData.title,
            description: newData.description,
            estTime: newData.estTime,
            category: newData.category,
            format: newData.format,
            step: '',
            time: newData.estTime,
            desc: newData.description,
            type: 'must',
            textbook: newData.textbook,
            tablet: newData.tablet,
            print: newData.print
        };
        dataStore.masterTasks.push(tempTask);
        renderTeacherDesignView(document.getElementById('t-area'));
        
        // ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰)
        google.script.run
          .withSuccessHandler(res => {
             if(res.success) {
               // æˆåŠŸæ™‚: IDã‚’æ­£å¼ãªã‚‚ã®ã«å·®ã—æ›¿ãˆ
               const realId = res.taskId;
               const targetIndex = dataStore.masterTasks.findIndex(t => t.taskId === tempId);
               if (targetIndex > -1) {
                   dataStore.masterTasks[targetIndex].taskId = realId;
                   // IDãŒå¤‰ã‚ã£ãŸã®ã§å†æç”»ã—ã¦DOMã®data-idã‚’æ›´æ–°ã—ã¦ãŠãï¼ˆæ¬¡å›ã®ç·¨é›†ã®ãŸã‚ï¼‰
                   renderTeacherDesignView(document.getElementById('t-area'));
               }
               showToast('success', 'ä¿å­˜å®Œäº†'); 
             } else { 
                 // å¤±æ•—æ™‚: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
                 dataStore.masterTasks = dataStore.masterTasks.filter(t => t.taskId !== tempId);
                 renderTeacherDesignView(document.getElementById('t-area'));
                 handleError(res); 
             }
          })
          .withFailureHandler(e => {
              // å¤±æ•—æ™‚: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
              dataStore.masterTasks = dataStore.masterTasks.filter(t => t.taskId !== tempId);
              renderTeacherDesignView(document.getElementById('t-area'));
              handleError(e);
          })
          .addUnitTask(appState.unit.id, newData);
      } else {
        const t = dataStore.masterTasks.find(x => x.taskId === taskId);
        t.title = newData.title;
        t.desc = newData.description;
        t.time = newData.estTime;
        t.category = newData.category;
        t.format = newData.format;
        t.textbook = newData.textbook;
        t.tablet = newData.tablet;
        t.print = newData.print;
        
        renderTeacherDesignView(document.getElementById('t-area'));
        google.script.run
          .withSuccessHandler(() => showToast('success', 'æ›´æ–°ã—ã¾ã—ãŸ'))
          .withFailureHandler(handleError)
          .updateUnitTask(taskId, newData);
      }
    } else if (r.isDenied) {
      Swal.fire({ title: 'å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', text: 'ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã€‚', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'å‰Šé™¤å®Ÿè¡Œ' }).then(delRes => {
        if(delRes.isConfirmed) {
          dataStore.masterTasks = dataStore.masterTasks.filter(t => t.taskId !== taskId);
          renderTeacherDesignView(document.getElementById('t-area'));
          google.script.run.withSuccessHandler(() => showToast('info', 'å‰Šé™¤ã—ã¾ã—ãŸ')).withFailureHandler(handleError).deleteUnitTask(taskId);
        }
      });
    }
  });
}

function openUnitInfoEditModal() {
  const unit = appState.unitList.find(u => u.id === appState.unit.id);
  if (!unit) return;

  Swal.fire({
    title: 'å˜å…ƒæƒ…å ±ã®ç·¨é›†',
    html: `
      <div class="text-start">
        <div class="mb-3"><label class="form-label small fw-bold">å˜å…ƒå <span class="text-danger">*</span></label><input id="ue-title" class="form-control" value="${unit.title || ''}"></div>
        <div class="row mb-3">
          <div class="col"><label class="form-label small fw-bold">æ•™ç§‘</label><input id="ue-subject" class="form-control" value="${unit.subject || ''}"></div>
          <div class="col"><label class="form-label small fw-bold">å­¦å¹´</label><input id="ue-grade" class="form-control" value="${unit.grade || ''}"></div>
        </div>
        <div class="mb-3"><label class="form-label small fw-bold">å˜å…ƒã®ã‚ã‚ã¦</label><textarea id="ue-goal" class="form-control" rows="2">${unit.goal || ''}</textarea></div>
        <div class="mb-3"><label class="form-label small fw-bold">æ¦‚è¦</label><textarea id="ue-description" class="form-control" rows="3">${unit.description || ''}</textarea></div>
      </div>`,
    showCancelButton: true,
    confirmButtonText: 'æ›´æ–°ã™ã‚‹',
    preConfirm: () => {
      const title = document.getElementById('ue-title').value;
      if (!title) { Swal.showValidationMessage('å˜å…ƒåã¯å¿…é ˆã§ã™'); return false; }
      return { title: title, subject: document.getElementById('ue-subject').value, grade: document.getElementById('ue-grade').value, goal: document.getElementById('ue-goal').value, description: document.getElementById('ue-description').value };
    }
  }).then(r => {
    if (r.isConfirmed) {
      const newData = r.value;
      unit.title = newData.title; unit.subject = newData.subject; unit.grade = newData.grade; unit.goal = newData.goal; unit.description = newData.description;
      appState.unit.title = unit.title;
      renderUnitSelector();
      renderTeacherDesignView(document.getElementById('t-area'));
      google.script.run.withSuccessHandler(() => showToast('success', 'å˜å…ƒæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ')).withFailureHandler(handleError).updateUnitBasicInfo(unit.id, newData);
    }
  });
}

function changeUnitTotalHours(delta) {
  const current = appState.unit.totalHours;
  const next = current + delta;
  if (next < 1) return;
  appState.unit.totalHours = next;
  renderTeacherDesignView(document.getElementById('t-area'));
  google.script.run
    .withFailureHandler(e => { appState.unit.totalHours = current; handleError(e); renderTeacherDesignView(document.getElementById('t-area')); })
    .withSuccessHandler(() => showToast('success', 'æ™‚æ•°ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'))
    .updateUnitTotalHours(appState.unit.id, next);
}

// ==========================================
//  5. æ–°è¦å˜å…ƒä½œæˆãƒ»AIã‚¤ãƒ³ãƒãƒ¼ãƒˆ (Unit Create)
// ==========================================

function openUnitManagerModal() {
  google.script.run.withSuccessHandler(res => {
    const initialPrompt = (res.success && res.prompt) ? res.prompt : DEFAULT_AI_PROMPT;

    Swal.fire({
      title: '<i class="bi bi-folder2-open me-2"></i>å˜å…ƒç®¡ç†',
      html: `
        <ul class="nav nav-tabs mb-3" id="unit-mgr-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="um-create-tab" data-bs-toggle="tab" data-bs-target="#um-create" type="button">æ‰‹å‹•ã§æ–°è¦ä½œæˆ</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="um-ai-tab" data-bs-toggle="tab" data-bs-target="#um-ai" type="button"><i class="bi bi-stars text-warning me-1"></i>AIã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          </li>
        </ul>
        <div class="tab-content text-start" id="unit-mgr-content">
          <!-- æ‰‹å‹•ä½œæˆã‚¿ãƒ– -->
          <div class="tab-pane fade show active" id="um-create" role="tabpanel">
            <div class="mb-3">
              <label class="form-label small fw-bold">å˜å…ƒå <span class="text-danger">*</span></label>
              <input id="cu-title" class="form-control" placeholder="ä¾‹ï¼šç«äº‹ã‹ã‚‰ãã‚‰ã—ã‚’å®ˆã‚‹">
            </div>
            <div class="row mb-3">
              <div class="col">
                <label class="form-label small fw-bold">æ•™ç§‘</label>
                <input id="cu-subject" class="form-control" placeholder="ä¾‹ï¼šç¤¾ä¼š">
              </div>
              <div class="col">
                <label class="form-label small fw-bold">å­¦å¹´</label>
                <input id="cu-grade" class="form-control" placeholder="ä¾‹ï¼š3å¹´">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label small fw-bold">ç·æ™‚æ•°ï¼ˆæ™‚é–“ï¼‰</label>
              <input type="number" id="cu-hours" class="form-control" value="8" min="1">
            </div>
            <div class="d-grid">
              <button class="btn btn-primary rounded-pill" onclick="submitCreateUnit()">ä½œæˆã™ã‚‹</button>
            </div>
          </div>
          
          <!-- AIã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
          <div class="tab-pane fade" id="um-ai" role="tabpanel">
            <div class="accordion mb-3" id="ai-steps">
              
              <!-- Step 1 Item -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1" aria-expanded="true" aria-controls="step1">
                    Step 1: AIã«å‘ªæ–‡ã‚’å”±ãˆã‚‹
                  </button>
                </h2>
                <div id="step1" class="accordion-collapse collapse show" data-bs-parent="#ai-steps">
                  <div class="accordion-body bg-light">
                    
                    <div class="d-flex justify-content-between align-items-end mb-2">
                      <p class="small text-muted mb-0">ã“ã®å‘ªæ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’AIã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚<br>å†…å®¹ã¯è‡ªç”±ã«ç·¨é›†ãƒ»ä¿å­˜ã§ãã¾ã™ã€‚</p>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="resetCustomPrompt()" title="åˆæœŸå€¤ã«æˆ»ã™"><i class="bi bi-arrow-counterclockwise"></i></button>
                        <button class="btn btn-outline-primary" onclick="saveCustomPrompt()" title="ã“ã®å†…å®¹ã‚’ä¿å­˜"><i class="bi bi-save"></i> ä¿å­˜</button>
                      </div>
                    </div>
                    
                    <textarea id="prompt-area" class="form-control mb-3 border-primary font-monospace" rows="12" style="font-size:0.8rem; white-space: pre-wrap;">${initialPrompt}</textarea>
                    
                    <button class="btn btn-primary w-100 mb-3" onclick="copyPrompt()">
                      <i class="bi bi-clipboard me-2"></i>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                    
                    <!-- [ä¿®æ­£] ãƒœã‚¿ãƒ³é…ç½®ã‚’ã‚°ãƒªãƒƒãƒ‰ã‚·ã‚¹ãƒ†ãƒ (row/col-6)ã§æ•´ç† -->
                    <div class="row g-2">
                      <div class="col-6">
                        <a href="https://chat.openai.com/" target="_blank" class="btn btn-dark w-100 d-flex align-items-center justify-content-center">
                          <i class="bi bi-robot me-2"></i>ChatGPT
                        </a>
                      </div>
                      <div class="col-6">
                        <a href="https://gemini.google.com/" target="_blank" class="btn btn-primary w-100 d-flex align-items-center justify-content-center" style="background-color: #0d6efd; border-color: #0d6efd;">
                          <i class="bi bi-stars me-2"></i>Gemini
                        </a>
                      </div>
                    </div>

                  </div><!-- End accordion-body -->
                </div><!-- End collapse -->
              </div><!-- End accordion-item -->
              
              <!-- Step 2 Item -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2" aria-expanded="false" aria-controls="step2">
                    Step 2: ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹
                  </button>
                </h2>
                <div id="step2" class="accordion-collapse collapse" data-bs-parent="#ai-steps">
                  <div class="accordion-body">
                    <p class="small text-muted mb-2">AIãŒä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ï¼ˆ { ... } ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                    <textarea id="json-input" class="form-control mb-3 font-monospace" rows="10" placeholder='{ "unitInfo": ... }' style="font-size:0.8rem;"></textarea>
                    <div class="d-grid">
                      <button class="btn btn-success rounded-pill" onclick="submitImportJson()"><i class="bi bi-file-earmark-code me-2"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                    </div>
                  </div>
                </div>
              </div>
              
            </div><!-- End accordion -->
          </div>
        </div>
      `,
      showConfirmButton: false,
      showCloseButton: true,
      width: '800px',
      didOpen: () => {
        const popup = Swal.getPopup();
        popup.style.transition = 'width 0.3s ease-in-out, max-width 0.3s ease-in-out';
        
        const tabCreate = document.getElementById('um-create-tab');
        const tabAi = document.getElementById('um-ai-tab');
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å¹…ã‚’èª¿æ•´
        tabCreate.addEventListener('shown.bs.tab', () => {
           popup.style.width = '600px';
           popup.style.maxWidth = '95vw';
        });
        
        tabAi.addEventListener('shown.bs.tab', () => {
           popup.style.width = '90%';
           popup.style.maxWidth = '1200px';
        });
      }
    });
  }).withFailureHandler(handleError).getCustomAiPrompt();
}

function submitCreateUnit() {
  const title = document.getElementById('cu-title').value;
  if (!title) { Swal.showValidationMessage('å˜å…ƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const data = { title: title, subject: document.getElementById('cu-subject').value, grade: document.getElementById('cu-grade').value, totalHours: parseInt(document.getElementById('cu-hours').value) || 8 };
  
  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        google.script.run.withSuccessHandler(dataRes => {
          updateDataStore(dataRes.json);
          changeUnit(res.unitId);
          renderUnitSelector();
          hideLoading();
          Swal.close();
          Swal.fire('ä½œæˆå®Œäº†', 'æ–°ã—ã„å˜å…ƒã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
        }).getData();
      } else { handleError(res); }
    })
    .withFailureHandler(handleError)
    .createNewUnit(data);
}

function copyPrompt() {
  const el = document.getElementById('prompt-area');
  el.select();
  document.execCommand('copy');
  const btn = document.querySelector('button[onclick="copyPrompt()"]');
  const originHTML = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-check"></i> ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
  btn.classList.replace('btn-outline-primary', 'btn-success');
  setTimeout(() => { btn.innerHTML = originHTML; btn.classList.replace('btn-success', 'btn-outline-primary'); }, 2000);
}

function saveCustomPrompt() {
  const text = document.getElementById('prompt-area').value;
  google.script.run.withSuccessHandler(() => showToast('success', 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ')).withFailureHandler(handleError).saveCustomAiPrompt(text);
}

function resetCustomPrompt() {
  if(confirm('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åˆæœŸå€¤ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
    document.getElementById('prompt-area').value = DEFAULT_AI_PROMPT;
  }
}

function submitImportJson() {
  const jsonStr = document.getElementById('json-input').value;
  if (!jsonStr) return;
  try { JSON.parse(jsonStr); } catch(e) { Swal.showValidationMessage('JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); return; }

  showLoading();
  google.script.run.withSuccessHandler(d => {
    if (d.success) {
      google.script.run.withSuccessHandler(dataRes => {
        updateDataStore(dataRes.json);
        if (appState.unitList.length > 0) {
           const newUnit = appState.unitList[0];
           changeUnit(newUnit.id);
           renderUnitSelector();
        }
        hideLoading();
        Swal.close();
        Swal.fire('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†', d.count + 'ä»¶ã®èª²é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
      }).getData();
    } else { handleError(d); }
  }).importUnitJson(jsonStr);
}

// [é€£æº] ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¸å˜å…ƒè¨ˆç”»ã‚’é€ä¿¡
function syncUnitToPassport() {
  if (!appState.passportDbId || !appState.passportUrl) {
    Swal.fire({ icon: 'warning', title: 'é€£æºæœªè¨­å®š', text: 'ã€Œã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã€ã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚å³ä¸Šã®è¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚' });
    return;
  }

  Swal.fire({
    title: 'ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆä½œæˆé€£æº',
    text: `ç¾åœ¨ã®å˜å…ƒã€Œ${appState.unit.title}ã€ã®è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¸é€ä¿¡ã—ã€ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’ä¸€æ‹¬ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#1a73e8',
    confirmButtonText: 'é€ä¿¡ã—ã¦ä½œæˆé–‹å§‹'
  }).then((result) => {
    if (result.isConfirmed) {
      showLoading();
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          if (res.success) {
            Swal.fire({ title: 'é€£æºæˆåŠŸ', text: 'ã¿ã‚‰ã„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹ãã¾ã™ã€‚', icon: 'success', timer: 2000, showConfirmButton: false });
            if (res.passportUrl) window.open(res.passportUrl, '_blank');
          } else {
            handleError({ message: res.message || 'é€£æºã«å¤±æ•—ã—ã¾ã—ãŸ' });
          }
        })
        .withFailureHandler(handleError)
        .sendUnitPlanToPassport_DirectDB(appState.unit.id);
    }
  });
}

// ==========================================
//  6. æˆæ¥­ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (Class Control)
// ==========================================

function renderControlView(container) {
  container.className = "flex-grow-1 overflow-auto p-3";
  const todayStr = new Date().toISOString().split('T')[0];
  const unitOptions = appState.unitList.map(u => `<option value="${u.id}">${u.title}</option>`).join('');
  const periodButtons = CONSTANTS.CLASS_PERIODS.map(p => `<button class="btn btn-outline-secondary btn-sm me-1 mb-1" onclick="setScheduleTime('${p.start}', '${p.end}')">${p.label}</button>`).join('');

  container.innerHTML = `
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          <div class="card-header bg-white border-0 fw-bold text-primary"><i class="bi bi-calendar-event me-2"></i>æˆæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é…ä¿¡</div>
          <div class="card-body">
            <p class="small text-muted">è¨­å®šã—ãŸæ—¥æ™‚ã«ã€å…ç«¥ã®ç”»é¢ã¸ã€Œæˆæ¥­ã¸ã®ç§»å‹•é€šçŸ¥ã€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            <div class="mb-3"><label class="form-label small">æ—¥ä»˜</label><input type="date" id="sc-date" class="form-control" value="${todayStr}"></div>
            <div class="mb-2"><label class="form-label small">æ™‚é–“å‰²ã‹ã‚‰é¸æŠ</label><div>${periodButtons}</div></div>
            <div class="row mb-3">
              <div class="col"><label class="form-label small">é–‹å§‹</label><input type="time" id="sc-start" class="form-control" value="08:45"></div>
              <div class="col"><label class="form-label small">çµ‚äº†</label><input type="time" id="sc-end" class="form-control" value="09:30"></div>
            </div>
            <div class="mb-3"><label class="form-label small">å˜å…ƒ</label><select id="sc-unit" class="form-select">${unitOptions}</select></div>
            <div class="mb-3"><label class="form-label small">æ™‚æ•°</label><input type="number" id="sc-hour" class="form-control" value="1" min="1"></div>
            <div class="mb-3"><label class="form-label small">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label><input type="text" id="sc-msg" class="form-control" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯ãƒ†ã‚¹ãƒˆã§ã™"></div>
            <button class="btn btn-primary w-100 rounded-pill" onclick="submitSchedule()">è¨­å®šã‚’é…ä¿¡ã™ã‚‹</button>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          <div class="card-header bg-white border-0 fw-bold text-success"><i class="bi bi-list-check me-2"></i>é…ä¿¡æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
          <div class="card-body">
            <div class="alert alert-light border small h-100 overflow-auto">
              <ul class="mb-0 ps-3">
                ${appState.schedules.map(s => {
                   const u = appState.unitList.find(ul => ul.id === s.unitId);
                   return `<li>${s.date} ${s.startTime}-${s.endTime}<br><strong>${u ? u.title : 'ä¸æ˜'}</strong> ç¬¬${s.hour}æ™‚<br><span class="text-muted">${s.message || ''}</span></li>`;
                }).join('') || 'äºˆå®šãªã—'}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>`;
}

function setScheduleTime(start, end) {
  document.getElementById('sc-start').value = start;
  document.getElementById('sc-end').value = end;
}

function submitSchedule() {
  const data = {
    classId: appState.view.teacherClassId === 'All' ? '1çµ„' : appState.view.teacherClassId, 
    date: document.getElementById('sc-date').value,
    startTime: document.getElementById('sc-start').value,
    endTime: document.getElementById('sc-end').value,
    unitId: document.getElementById('sc-unit').value,
    hour: document.getElementById('sc-hour').value,
    message: document.getElementById('sc-msg').value
  };
  
  if(!data.date || !data.startTime || !data.endTime) return Swal.fire('ã‚¨ãƒ©ãƒ¼', 'æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
  
  google.script.run.withSuccessHandler(() => {
    showToast('success', 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é…ä¿¡ã—ã¾ã—ãŸ');
    loadMainData();
  }).saveClassSchedule(data);
}

// ==========================================
//  7. åç°¿ç®¡ç† (Roster)
// ==========================================

let rosterEditData = []; // ç·¨é›†ä¸­ã®åç°¿ãƒ‡ãƒ¼ã‚¿ä¸€æ™‚ä¿æŒ

function openRosterManagerModal() {
  Swal.close();
  
  // åˆæœŸå€¤ã¨ã—ã¦ç¾åœ¨ã®ã‚¯ãƒ©ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
  const currentClass = appState.view.teacherClassId !== 'All' ? appState.view.teacherClassId : (dataStore.classList[0] || '1çµ„');
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  Swal.fire({
    title: '<i class="bi bi-people-fill me-2"></i>åç°¿ç®¡ç†',
    html: `
      <div class="text-start" style="min-height: 500px; display: flex; flex-direction: column;">
        
        <!-- ä¸Šéƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
        <div class="row g-2 align-items-center mb-3 p-2 bg-light rounded">
          <div class="col-auto">
            <label class="form-label small fw-bold mb-0">ã‚¯ãƒ©ã‚¹å</label>
          </div>
          <div class="col-auto">
            <input type="text" id="roster-class" class="form-control form-control-sm text-center fw-bold" 
                   list="roster-class-list" placeholder="ä¾‹: 1çµ„" value="${currentClass}" style="width: 100px;">
            <datalist id="roster-class-list">
              <option value="1çµ„"><option value="2çµ„"><option value="3çµ„">
            </datalist>
          </div>
          <div class="col">
            <div class="btn-group btn-group-sm w-100">
              <button class="btn btn-outline-secondary" onclick="loadRosterFromDB()">
                <i class="bi bi-arrow-clockwise"></i> å†èª­è¾¼
              </button>
              <button class="btn btn-outline-secondary" onclick="document.getElementById('csv-upload').click()">
                <i class="bi bi-upload"></i> CSVèª­è¾¼
              </button>
              <button class="btn btn-outline-secondary" onclick="cleanRosterData()">
                <i class="bi bi-magic"></i> æ•´ç†ãƒ»ã‚½ãƒ¼ãƒˆ
              </button>
            </div>
            <input type="file" id="csv-upload" accept=".csv" style="display:none" onchange="loadRosterFromCSV(this)">
          </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼šå·¦å³åˆ†å‰² -->
        <div class="row flex-grow-1 g-3" style="min-height: 0;">
          
          <!-- å·¦å´ï¼šè²¼ã‚Šä»˜ã‘ã‚¨ãƒªã‚¢ -->
          <div class="col-4 d-flex flex-column">
            <label class="form-label small fw-bold text-muted">
              <i class="bi bi-clipboard"></i> Excel/ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è²¼ã‚Šä»˜ã‘
            </label>
            <textarea id="paste-area" class="form-control flex-grow-1 small" 
                      placeholder="ã“ã“ã«Excelã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€è‡ªå‹•çš„ã«å³å´ã®è¡¨ã«å–ã‚Šè¾¼ã¾ã‚Œã¾ã™ã€‚&#13;&#10;&#13;&#10;[ç•ªå·] [åå‰] ã®é †ã ã¨èªè­˜ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚"
                      style="resize: none; font-family: monospace; font-size: 0.85rem;"></textarea>
          </div>

          <!-- å³å´ï¼šç·¨é›†ã‚°ãƒªãƒƒãƒ‰ -->
          <div class="col-8 d-flex flex-column">
            <div class="table-responsive border rounded bg-white flex-grow-1">
              <table class="table table-sm table-hover table-bordered mb-0 small" id="roster-table">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width: 60px;" class="text-center">No.</th>
                    <th>æ°å</th>
                    <th style="width: 80px;" class="text-center">åœ¨ç±</th>
                    <th style="width: 40px;"></th>
                  </tr>
                </thead>
                <tbody id="roster-tbody">
                  <!-- JSã§ç”Ÿæˆ -->
                </tbody>
              </table>
            </div>
            <div class="mt-2 text-end">
              <button class="btn btn-sm btn-outline-primary" onclick="addRosterRow()">
                <i class="bi bi-plus-lg"></i> è¡Œã‚’è¿½åŠ 
              </button>
            </div>
          </div>
        </div>

        <!-- ä¸‹éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mt-3 pt-3 border-top d-flex justify-content-between align-items-center">
          <span class="small text-muted" id="roster-count">0å</span>
          <button class="btn btn-success rounded-pill px-4" onclick="submitSaveRoster()">
            <i class="bi bi-save me-1"></i>ä¿å­˜ã™ã‚‹
          </button>
        </div>
      </div>
    `,
    width: '90%',
    maxWidth: '1000px',
    showConfirmButton: false,
    showCloseButton: true,
    didOpen: () => {
      // åˆæœŸãƒ­ãƒ¼ãƒ‰
      loadRosterFromDB();
      
      // ã‚¯ãƒ©ã‚¹åå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('roster-class').addEventListener('change', loadRosterFromDB);
      
      // è²¼ã‚Šä»˜ã‘ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('paste-area').addEventListener('paste', handlePaste);
      document.getElementById('paste-area').addEventListener('input', (e) => {
         // å…¥åŠ›ï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰ã•ã‚ŒãŸã‚‰è§£æã—ã¦ã‚¯ãƒªã‚¢
         if(e.target.value.trim()) {
           parsePastedText(e.target.value);
           e.target.value = ''; // ã‚¯ãƒªã‚¢ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
         }
      });
    }
  });
}

function loadRosterFromDB() {
  const classId = document.getElementById('roster-class').value;
  if (!classId) return;

  // ç¾åœ¨ã®ã‚¹ãƒˆã‚¢ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚»ãƒƒãƒˆ
  rosterEditData = dataStore.roster
    .filter(r => r.classId === classId)
    .sort((a,b) => a.number - b.number)
    .map(r => ({
      number: r.number || 999,
      name: r.name,
      isActive: r.isActive !== false // undefined or true -> true
    }));
  
  renderRosterTable();
}

function renderRosterTable() {
  const tbody = document.getElementById('roster-tbody');
  tbody.innerHTML = '';
  
  rosterEditData.forEach((student, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="number" class="form-control form-control-sm border-0 p-0 text-center" value="${student.number}" onchange="updateRosterData(${index}, 'number', this.value)"></td>
      <td><input type="text" class="form-control form-control-sm border-0 p-0 px-1" value="${student.name}" onchange="updateRosterData(${index}, 'name', this.value)"></td>
      <td class="text-center align-middle">
        <div class="form-check form-switch d-flex justify-content-center">
          <input class="form-check-input" type="checkbox" ${student.isActive ? 'checked' : ''} onchange="updateRosterData(${index}, 'isActive', this.checked)" title="${student.isActive?'è¡¨ç¤º':'éè¡¨ç¤º(è»¢å‡º)'}">
        </div>
      </td>
      <td class="text-center align-middle">
        <i class="bi bi-x text-danger cursor-pointer" onclick="removeRosterRow(${index})"></i>
      </td>
    `;
    // éè¡¨ç¤º(è»¢å‡º)ã®å ´åˆã¯è¡Œã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
    if (!student.isActive) {
        tr.style.backgroundColor = '#f8f9fa';
        tr.style.color = '#adb5bd';
        tr.querySelectorAll('input[type="text"], input[type="number"]').forEach(el => el.style.color = '#adb5bd');
    }
    tbody.appendChild(tr);
  });
  
  document.getElementById('roster-count').textContent = `${rosterEditData.length}å`;
}

function updateRosterData(index, field, value) {
  if (field === 'number') rosterEditData[index].number = parseInt(value) || 0;
  if (field === 'name') rosterEditData[index].name = value;
  if (field === 'isActive') {
      rosterEditData[index].isActive = value;
      renderRosterTable(); // è‰²æ›´æ–°ã®ãŸã‚å†æç”»
  }
}

function addRosterRow() {
  const nextNum = rosterEditData.length > 0 ? Math.max(...rosterEditData.map(s=>s.number)) + 1 : 1;
  rosterEditData.push({ number: nextNum, name: '', isActive: true });
  renderRosterTable();
}

function removeRosterRow(index) {
  rosterEditData.splice(index, 1);
  renderRosterTable();
}

function handlePaste(e) {
  // ãƒšãƒ¼ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã§ã®å‡¦ç†
  setTimeout(() => {
    const text = e.target.value;
    if (text) parsePastedText(text);
    e.target.value = '';
  }, 100);
}

function parsePastedText(text) {
  // æ”¹è¡Œã§åˆ†å‰²
  const lines = text.split(/\r\n|\n|\r/).filter(line => line.trim() !== '');
  if (lines.length === 0) return;

  let addedCount = 0;
  
  lines.forEach(line => {
    // ã‚¿ãƒ–ã¾ãŸã¯ã‚«ãƒ³ãƒã§åˆ†å‰²
    const cols = line.split(/\t|,/).map(c => c.trim()).filter(c => c);
    if(cols.length === 0) return;

    let num = 0;
    let name = "";
    
    // ãƒ‡ãƒ¼ã‚¿è§£æãƒ­ã‚¸ãƒƒã‚¯
    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: [ç•ªå·] [åå‰] ...
    if (cols.length >= 2 && !isNaN(cols[0])) {
        num = parseInt(cols[0]);
        name = cols[1];
    } 
    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: [åå‰] ã®ã¿
    else if (cols.length >= 1) {
        // è‡ªå‹•æ¡ç•ª: ç¾åœ¨ã®æœ€å¤§å€¤ + 1
        const maxNum = rosterEditData.length > 0 ? Math.max(...rosterEditData.map(s=>s.number)) : 0;
        num = maxNum + 1;
        name = cols[0];
    }
    
    if (name) {
        // åå‰ãŒé‡è¤‡ã—ã¦ã„ãªã„ã‹ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰
        rosterEditData.push({ number: num, name: name, isActive: true });
        addedCount++;
    }
  });
  
  if (addedCount > 0) {
      showToast('success', `${addedCount}ä»¶ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
      renderRosterTable();
  }
}

function loadRosterFromCSV(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    parsePastedText(text); // æ—¢å­˜ã®ãƒ‘ãƒ¼ã‚¹é–¢æ•°ã‚’æµç”¨
    input.value = ''; // ãƒªã‚»ãƒƒãƒˆ
  };
  // Excelã®CSVã¯Shift_JISãŒå¤šã„ã®ã§å¯¾å¿œ
  reader.readAsText(file, 'Shift_JIS');
}

function cleanRosterData() {
  // 1. åå‰ã®ã‚¹ãƒšãƒ¼ã‚¹æ•´å½¢ï¼ˆå…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’çµ±ä¸€ï¼‰
  // 2. ç©ºè¡Œå‰Šé™¤
  // 3. ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
  
  rosterEditData = rosterEditData.filter(s => s.name && s.name.trim() !== '');
  rosterEditData.forEach(s => {
      // å§“ã¨åã®é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹1ã¤ã«çµ±ä¸€
      s.name = s.name.replace(/\s+/g, ' ').trim(); 
  });
  
  // ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
  rosterEditData.sort((a, b) => a.number - b.number);
  
  renderRosterTable();
  showToast('info', 'ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ãƒ»ã‚½ãƒ¼ãƒˆã—ã¾ã—ãŸ');
}

function submitSaveRoster() {
  const classId = document.getElementById('roster-class').value;
  if (!classId) { Swal.showValidationMessage('ã‚¯ãƒ©ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  
  if (rosterEditData.length === 0) {
     if(!confirm('åç°¿ãŒç©ºã§ã™ãŒã€ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿï¼ˆç¾åœ¨ã®åç°¿ãŒæ¶ˆå»ã•ã‚Œã¾ã™ï¼‰')) return;
  }

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      if (res.success) {
        google.script.run.withSuccessHandler(d => {
          updateDataStore(d.json);
          hideLoading();
          Swal.close();
          showToast('success', `${classId}ã®åç°¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
        }).getData();
      } else { handleError(res); }
    })
    .withFailureHandler(handleError)
    .saveClassRoster(classId, rosterEditData); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã‚’é€ä¿¡
}

// ==========================================
//  8. ãã®ä»–è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
// ==========================================

function showStudentTaskDetail(name, tid) {
  const t = dataStore.masterTasks.find(x => x.taskId === tid);
  const p = (dataStore.clsProgress[name] && dataStore.clsProgress[name][tid]) || {};
  Swal.fire({
    title: `${name} ã•ã‚“ã®çŠ¶æ³`,
    html: `<div class="text-start"><h6 class="fw-bold text-primary">${t.title}</h6><div class="mb-3"><span class="badge bg-secondary me-1">çŠ¶æ…‹: ${p.status||'æœª'}</span></div><div class="p-3 bg-light rounded mb-3 small">${p.reflection||'ãƒ¡ãƒ¢ãªã—'}</div><hr><div class="d-flex justify-content-center gap-2"><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','check')">âœ…</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','good')">ğŸ‘</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','great')">ğŸ’®</button><button class="btn btn-outline-primary rounded-circle p-2" style="width:50px;height:50px;font-size:1.5rem" onclick="sendStamp('${name}','${tid}','support')">ğŸš©</button></div></div>`,
    showConfirmButton: false,
    showCloseButton: true
  });
}

function sendStamp(name, tid, stamp) {
  if (!dataStore.clsFeedback[name]) dataStore.clsFeedback[name] = {};
  dataStore.clsFeedback[name][tid] = stamp;
  renderTeacherDashboardContent(); // æ›´æ–°
  showToast('success', 'ã‚¹ã‚¿ãƒ³ãƒ—é€ä¿¡');
  google.script.run.sendFeedback(name, tid, stamp, appState.view.teacherClassId !== 'All' ? appState.view.teacherClassId : '');
}

/**
 * [ãƒ¢ãƒ¼ãƒ€ãƒ«] ã‚¿ã‚¹ã‚¯è©³ç´°è¡¨ç¤ºï¼ˆå…ˆç”Ÿç”¨ãƒ»ãƒªãƒ³ã‚¯å¯¾å¿œï¼‰
 */
function showTeacherTaskDetailSimple(tid) {
  const t = dataStore.masterTasks.find(x => x.taskId === tid);
  if (!t) return;

  const parseMat = (str) => { try { return JSON.parse(str||'{}'); } catch(e){ return {name:str,url:''}; } };
  const materials = [
    { type: 'textbook', label: 'æ•™ç§‘æ›¸ãƒ»è³‡æ–™', icon: 'bi-book', data: parseMat(t.textbook) },
    { type: 'tablet', label: 'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¢ãƒ—ãƒª', icon: 'bi-tablet', data: parseMat(t.tablet) },
    { type: 'print', label: 'ãƒ—ãƒªãƒ³ãƒˆãƒ»ãã®ä»–', icon: 'bi-file-earmark-text', data: parseMat(t.print) }
  ];

  let materialHtml = '';
  materials.forEach(m => {
    if (m.data.name) {
      if (m.data.url) {
        materialHtml += `<a href="${m.data.url}" target="_blank" class="btn btn-outline-primary btn-sm w-100 mb-2 text-start text-truncate"><i class="bi ${m.icon} me-2"></i>${m.data.name}</a>`;
      } else {
        materialHtml += `<div class="mb-2 text-truncate"><span class="badge bg-light text-dark border me-2"><i class="bi ${m.icon}"></i> ${m.label}</span><span class="small">${m.data.name}</span></div>`;
      }
    }
  });

  Swal.fire({
    title: t.title,
    html: `
      <div class="text-start">
        <p class="text-muted border p-3 rounded bg-light mb-3">${t.desc || 'èª¬æ˜ãªã—'}</p>
        ${materialHtml ? '<div class="mb-3 border-top pt-2"><div class="small fw-bold text-muted mb-2">å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹</div>' + materialHtml + '</div>' : ''}
        <div class="text-end small text-muted">æ™‚é–“: ${t.time}åˆ†</div>
      </div>`,
    showConfirmButton: false,
    showCloseButton: true
  });
}
</script>
